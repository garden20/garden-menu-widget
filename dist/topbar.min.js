(function(){(function(e,t){typeof define=="function"&&define.amd?define(["querystring"],t):e.url=t(e.querystring)})(this,function(e){function b(t,r,o){if(t&&typeof t=="object"&&t.href)return t;if(typeof t!="string")throw new TypeError("Parameter 'url' must be a string, not "+typeof t);var a={},g=t;for(var b=0,E=g.length;b<E;b++)if(i(u,g.charAt(b))===-1)break;b!==0&&(g=g.substr(b));var S=s.exec(g);if(S){S=S[0];var T=S.toLowerCase();a.protocol=T,g=g.substr(S.length)}if(o||S||g.match(/^\/\/[^@\/]+@[^@\/]+/)){var N=g.substr(0,2)==="//";N&&(!S||!m[S])&&(g=g.substr(2),a.slashes=!0)}if(!m[S]&&(N||S&&!y[S])){var C=g.indexOf("@");if(C!==-1){var k=!0;for(var b=0,E=c.length;b<E;b++){var L=g.indexOf(c[b]);if(L!==-1&&L<C){k=!1;break}}k&&(a.auth=g.substr(0,C),g=g.substr(C+1))}var A=-1;for(var b=0,E=l.length;b<E;b++){var L=g.indexOf(l[b]);L!==-1&&(A<0||L<A)&&(A=L)}A!==-1?(a.host=g.substr(0,A),g=g.substr(A)):(a.host=g,g="");var O=x(a.host),M=n(O);for(var b=0,E=M.length;b<E;b++){var _=M[b];a[_]=O[_]}a.hostname=a.hostname||"";if(a.hostname.length>h)a.hostname="";else{var D=a.hostname.split(/\./);for(var b=0,E=D.length;b<E;b++){var P=D[b];if(!P)continue;if(!P.match(p)){var H="";for(var B=0,j=P.length;B<j;B++)P.charCodeAt(B)>127?H+="x":H+=P[B];if(!H.match(p)){var F=D.slice(0,b),I=D.slice(b+1),q=P.match(d);q&&(F.push(q[1]),I.unshift(q[2])),I.length&&(g="/"+I.join(".")+g),a.hostname=F.join(".");break}}}}a.hostname=a.hostname.toLowerCase(),a.host=(a.hostname||"")+(a.port?":"+a.port:""),a.href+=a.host}if(!v[T]){for(var b=0,E=f.length;b<E;b++){var R=f[b],U=encodeURIComponent(R);U===R&&(U=escape(R)),g=g.split(R).join(U)}var z=g.length;for(var b=0,E=u.length;b<E;b++){var W=g.indexOf(u[b]);W!==-1&&(z=Math.min(W,z))}g=g.substr(0,z)}var X=g.indexOf("#");X!==-1&&(a.hash=g.substr(X),g=g.slice(0,X));var V=g.indexOf("?");V!==-1?(a.search=g.substr(V),a.query=g.substr(V+1),r&&(a.query=e.parse(a.query)),g=g.slice(0,V)):r&&(a.search="",a.query={}),g&&(a.pathname=g),y[S]&&a.hostname&&!a.pathname&&(a.pathname="/");if(a.pathname||a.search)a.path=(a.pathname?a.pathname:"")+(a.search?a.search:"");return a.href=w(a),a}function w(t){typeof t=="string"&&(t=b(t));var r=t.auth||"";if(r){r=r.split("@").join("%40");for(var i=0,s=c.length;i<s;i++){var o=c[i];r=r.split(o).join(encodeURIComponent(o))}r+="@"}var u=t.protocol||"",a=t.host!==undefined?r+t.host:t.hostname!==undefined?r+t.hostname+(t.port?":"+t.port:""):!1,f=t.pathname||"",l=t.query&&(typeof t.query=="object"&&n(t.query).length?e.stringify(t.query):"")||"",h=t.search||l&&"?"+l||"",p=t.hash||"";return u&&u.substr(u.length-1)!==":"&&(u+=":"),t.slashes||(!u||y[u])&&a!==!1?(a="//"+(a||""),f&&f.charAt(0)!=="/"&&(f="/"+f)):a||(a=""),p&&p.charAt(0)!=="#"&&(p="#"+p),h&&h.charAt(0)!=="?"&&(h="?"+h),u+a+f+h+p}function E(e,t){return w(S(e,t))}function S(e,t){if(!e)return t;e=b(w(e),!1,!0),t=b(w(t),!1,!0),e.hash=t.hash;if(t.href==="")return e.href=w(e),e;if(t.slashes&&!t.protocol)return t.protocol=e.protocol,y[t.protocol]&&t.hostname&&!t.pathname&&(t.path=t.pathname="/"),t.href=w(t),t;if(t.protocol&&t.protocol!==e.protocol){if(!y[t.protocol])return t.href=w(t),t;e.protocol=t.protocol;if(!t.host&&!m[t.protocol]){var n=(t.pathname||"").split("/");while(n.length&&!(t.host=n.shift()));t.host||(t.host=""),t.hostname||(t.hostname=""),n[0]!==""&&n.unshift(""),n.length<2&&n.unshift(""),t.pathname=n.join("/")}e.pathname=t.pathname,e.search=t.search,e.query=t.query,e.host=t.host||"",e.auth=t.auth,e.hostname=t.hostname||t.host,e.port=t.port;if(e.pathname!==undefined||e.search!==undefined)e.path=(e.pathname?e.pathname:"")+(e.search?e.search:"");return e.slashes=e.slashes||t.slashes,e.href=w(e),e}var r=e.pathname&&e.pathname.charAt(0)==="/",i=t.host!==undefined||t.pathname&&t.pathname.charAt(0)==="/",s=i||r||e.host&&t.pathname,o=s,u=e.pathname&&e.pathname.split("/")||[],n=t.pathname&&t.pathname.split("/")||[],a=e.protocol&&!y[e.protocol];a&&(delete e.hostname,delete e.port,e.host&&(u[0]===""?u[0]=e.host:u.unshift(e.host)),delete e.host,t.protocol&&(delete t.hostname,delete t.port,t.host&&(n[0]===""?n[0]=t.host:n.unshift(t.host)),delete t.host),s=s&&(n[0]===""||u[0]===""));if(i)e.host=t.host||t.host===""?t.host:e.host,e.hostname=t.hostname||t.hostname===""?t.hostname:e.hostname,e.search=t.search,e.query=t.query,u=n;else if(n.length)u||(u=[]),u.pop(),u=u.concat(n),e.search=t.search,e.query=t.query;else if("search"in t){if(a){e.hostname=e.host=u.shift();var f=e.host&&e.host.indexOf("@")>0?e.host.split("@"):!1;f&&(e.auth=f.shift(),e.host=e.hostname=f.shift())}e.search=t.search,e.query=t.query;if(e.pathname!==undefined||e.search!==undefined)e.path=(e.pathname?e.pathname:"")+(e.search?e.search:"");return e.href=w(e),e}if(!u.length)return delete e.pathname,e.search?delete e.path:e.path="/"+e.search,e.href=w(e),e;var l=u.slice(u.length-1)[0],c=(e.host||t.host)&&(l==="."||l==="..")||l==="",h=0;for(var p=u.length;p>=0;p--)l=u[p],l=="."?u.splice(p,1):l===".."?(u.splice(p,1),h++):h&&(u.splice(p,1),h--);if(!s&&!o)for(;h--;h)u.unshift("..");s&&u[0]!==""&&(!u[0]||u[0].charAt(0)!=="/")&&u.unshift(""),c&&u.join("/").substr(u.join("/").length-1)!=="/"&&u.push("");var d=u[0]===""||u[0]&&u[0].charAt(0)==="/";if(a){e.hostname=e.host=d?"":u.length?u.shift():"";var f=e.host&&e.host.indexOf("@")>0?e.host.split("@"):!1;f&&(e.auth=f.shift(),e.host=e.hostname=f.shift())}s=s||e.host&&u.length,s&&!d&&u.unshift(""),e.pathname=u.join("/");if(e.pathname!==undefined||e.search!==undefined)e.path=(e.pathname?e.pathname:"")+(e.search?e.search:"");return e.auth=t.auth||e.auth,e.slashes=e.slashes||t.slashes,e.href=w(e),e}function x(e){var t={},n=o.exec(e);return n&&(n=n[0],t.port=n.substr(1),e=e.substr(0,e.length-n.length)),e&&(t.hostname=e),t}var t={},n=Object.keys||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},r=Array.prototype.indexOf,i=function(e,t){if(e==null)return-1;var n,i;if(r&&e.indexOf===r)return e.indexOf(t);for(n=0,i=e.length;n<i;n++)if(e[n]===t)return n;return-1};t.parse=b,t.resolve=E,t.resolveObject=S,t.format=w;var s=/^([a-z0-9.+-]+:)/i,o=/:[0-9]+$/,u=["<",">",'"',"`"," ","\r","\n","	"],a=["{","}","|","\\","^","~","[","]","`"].concat(u),f=["'"],l=["%","/","?",";","#"].concat(a).concat(f),c=["/","@","?","#"].concat(u),h=255,p=/^[a-zA-Z0-9][a-z0-9A-Z_-]{0,62}$/,d=/^([a-zA-Z0-9][a-z0-9A-Z_-]{0,62})(.*)$/,v={javascript:!0,"javascript:":!0},m={javascript:!0,"javascript:":!0},g={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},y={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0};return t}),function(){var e={},t=this,n=t.async;e.noConflict=function(){return t.async=n,e};var r=function(e,t){if(e.forEach)return e.forEach(t);for(var n=0;n<e.length;n+=1)t(e[n],n,e)},i=function(e,t){if(e.map)return e.map(t);var n=[];return r(e,function(e,r,i){n.push(t(e,r,i))}),n},s=function(e,t,n){return e.reduce?e.reduce(t,n):(r(e,function(e,r,i){n=t(n,e,r,i)}),n)},o=function(e){if(Object.keys)return Object.keys(e);var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t};typeof process=="undefined"||!process.nextTick?e.nextTick=function(e){setTimeout(e,0)}:e.nextTick=process.nextTick,e.forEach=function(e,t,n){n=n||function(){};if(!e.length)return n();var i=0;r(e,function(r){t(r,function(t){t?(n(t),n=function(){}):(i+=1,i===e.length&&n(null))})})},e.forEachSeries=function(e,t,n){n=n||function(){};if(!e.length)return n();var r=0,i=function(){t(e[r],function(t){t?(n(t),n=function(){}):(r+=1,r===e.length?n(null):i())})};i()},e.forEachLimit=function(e,t,n,r){r=r||function(){};if(!e.length||t<=0)return r();var i=0,s=0,o=0;(function u(){if(i===e.length)return r();while(o<t&&s<e.length)s+=1,o+=1,n(e[s-1],function(t){t?(r(t),r=function(){}):(i+=1,o-=1,i===e.length?r():u())})})()};var u=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.forEach].concat(n))}},a=function(t){return function(){var n=Array.prototype.slice.call(arguments);return t.apply(null,[e.forEachSeries].concat(n))}},f=function(e,t,n,r){var s=[];t=i(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n,r){s[e.index]=r,t(n)})},function(e){r(e,s)})};e.map=u(f),e.mapSeries=a(f),e.reduce=function(t,n,r,i){e.forEachSeries(t,function(e,t){r(n,e,function(e,r){n=r,t(e)})},function(e){i(e,n)})},e.inject=e.reduce,e.foldl=e.reduce,e.reduceRight=function(t,n,r,s){var o=i(t,function(e){return e}).reverse();e.reduce(o,n,r,s)},e.foldr=e.reduceRight;var l=function(e,t,n,r){var s=[];t=i(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n&&s.push(e),t()})},function(e){r(i(s.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.filter=u(l),e.filterSeries=a(l),e.select=e.filter,e.selectSeries=e.filterSeries;var c=function(e,t,n,r){var s=[];t=i(t,function(e,t){return{index:t,value:e}}),e(t,function(e,t){n(e.value,function(n){n||s.push(e),t()})},function(e){r(i(s.sort(function(e,t){return e.index-t.index}),function(e){return e.value}))})};e.reject=u(c),e.rejectSeries=a(c);var h=function(e,t,n,r){e(t,function(e,t){n(e,function(n){n?(r(e),r=function(){}):t()})},function(e){r()})};e.detect=u(h),e.detectSeries=a(h),e.some=function(t,n,r){e.forEach(t,function(e,t){n(e,function(e){e&&(r(!0),r=function(){}),t()})},function(e){r(!1)})},e.any=e.some,e.every=function(t,n,r){e.forEach(t,function(e,t){n(e,function(e){e||(r(!1),r=function(){}),t()})},function(e){r(!0)})},e.all=e.every,e.sortBy=function(t,n,r){e.map(t,function(e,t){n(e,function(n,r){n?t(n):t(null,{value:e,criteria:r})})},function(e,t){if(e)return r(e);var n=function(e,t){var n=e.criteria,r=t.criteria;return n<r?-1:n>r?1:0};r(null,i(t.sort(n),function(e){return e.value}))})},e.auto=function(e,t){t=t||function(){};var n=o(e);if(!n.length)return t(null);var i={},u=[],a=function(e){u.unshift(e)},f=function(e){for(var t=0;t<u.length;t+=1)if(u[t]===e){u.splice(t,1);return}},l=function(){r(u.slice(0),function(e){e()})};a(function(){o(i).length===n.length&&(t(null,i),t=function(){})}),r(n,function(n){var r=e[n]instanceof Function?[e[n]]:e[n],o=function(e){if(e)t(e),t=function(){};else{var r=Array.prototype.slice.call(arguments,1);r.length<=1&&(r=r[0]),i[n]=r,l()}},u=r.slice(0,Math.abs(r.length-1))||[],c=function(){return s(u,function(e,t){return e&&i.hasOwnProperty(t)},!0)&&!i.hasOwnProperty(n)};if(c())r[r.length-1](o,i);else{var h=function(){c()&&(f(h),r[r.length-1](o,i))};a(h)}})},e.waterfall=function(t,n){n=n||function(){};if(!t.length)return n();var r=function(t){return function(i){if(i)n(i),n=function(){};else{var s=Array.prototype.slice.call(arguments,1),o=t.next();o?s.push(r(o)):s.push(n),e.nextTick(function(){t.apply(null,s)})}}};r(e.iterator(t))()},e.parallel=function(t,n){n=n||function(){};if(t.constructor===Array)e.map(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.forEach(o(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}},e.series=function(t,n){n=n||function(){};if(t.constructor===Array)e.mapSeries(t,function(e,t){e&&e(function(e){var n=Array.prototype.slice.call(arguments,1);n.length<=1&&(n=n[0]),t.call(null,e,n)})},n);else{var r={};e.forEachSeries(o(t),function(e,n){t[e](function(t){var i=Array.prototype.slice.call(arguments,1);i.length<=1&&(i=i[0]),r[e]=i,n(t)})},function(e){n(e,r)})}},e.iterator=function(e){var t=function(n){var r=function(){return e.length&&e[n].apply(null,arguments),r.next()};return r.next=function(){return n<e.length-1?t(n+1):null},r};return t(0)},e.apply=function(e){var t=Array.prototype.slice.call(arguments,1);return function(){return e.apply(null,t.concat(Array.prototype.slice.call(arguments)))}};var p=function(e,t,n,r){var i=[];e(t,function(e,t){n(e,function(e,n){i=i.concat(n||[]),t(e)})},function(e){r(e,i)})};e.concat=u(p),e.concatSeries=a(p),e.whilst=function(t,n,r){t()?n(function(i){if(i)return r(i);e.whilst(t,n,r)}):r()},e.until=function(t,n,r){t()?r():n(function(i){if(i)return r(i);e.until(t,n,r)})},e.queue=function(t,n){var i=0,s={tasks:[],concurrency:n,saturated:null,empty:null,drain:null,push:function(t,i){t.constructor!==Array&&(t=[t]),r(t,function(t){s.tasks.push({data:t,callback:typeof i=="function"?i:null}),s.saturated&&s.tasks.length==n&&s.saturated(),e.nextTick(s.process)})},process:function(){if(i<s.concurrency&&s.tasks.length){var e=s.tasks.shift();s.empty&&s.tasks.length==0&&s.empty(),i+=1,t(e.data,function(){i-=1,e.callback&&e.callback.apply(e,arguments),s.drain&&s.tasks.length+i==0&&s.drain(),s.process()})}},length:function(){return s.tasks.length},running:function(){return i}};return s};var d=function(e){return function(t){var n=Array.prototype.slice.call(arguments,1);t.apply(null,n.concat([function(t){var n=Array.prototype.slice.call(arguments,1);typeof console!="undefined"&&(t?console.error&&console.error(t):console[e]&&r(n,function(t){console[e](t)}))}]))}};e.log=d("log"),e.dir=d("dir"),e.memoize=function(e,t){var n={},r={};t=t||function(e){return e};var i=function(){var i=Array.prototype.slice.call(arguments),s=i.pop(),o=t.apply(null,i);o in n?s.apply(null,n[o]):o in r?r[o].push(s):(r[o]=[s],e.apply(null,i.concat([function(){n[o]=arguments;var e=r[o];delete r[o];for(var t=0,i=e.length;t<i;t++)e[t].apply(null,arguments)}])))};return i.unmemoized=e,i},e.unmemoize=function(e){return function(){return(e.unmemoized||e).apply(null,arguments)}},typeof define!="undefined"&&define.amd?define("async",[],function(){return e}):typeof module!="undefined"&&module.exports?module.exports=e:t.async=e}(),function(){function C(e,t,n){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;e._chain&&(e=e._wrapped),t._chain&&(t=t._wrapped);if(e.isEqual&&S.isFunction(e.isEqual))return e.isEqual(t);if(t.isEqual&&S.isFunction(t.isEqual))return t.isEqual(e);var r=a.call(e);if(r!=a.call(t))return!1;switch(r){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return!1;var i=n.length;while(i--)if(n[i]==e)return!0;n.push(e);var s=0,o=!0;if(r=="[object Array]"){s=e.length,o=s==t.length;if(o)while(s--)if(!(o=s in e==s in t&&C(e[s],t[s],n)))break}else{if("constructor"in e!="constructor"in t||e.constructor!=t.constructor)return!1;for(var u in e)if(S.has(e,u)){s++;if(!(o=S.has(t,u)&&C(e[u],t[u],n)))break}if(o){for(u in t)if(S.has(t,u)&&!(s--))break;o=!s}}return n.pop(),o}var e=this,t=e._,n={},r=Array.prototype,i=Object.prototype,s=Function.prototype,o=r.slice,u=r.unshift,a=i.toString,f=i.hasOwnProperty,l=r.forEach,c=r.map,h=r.reduce,p=r.reduceRight,d=r.filter,v=r.every,m=r.some,g=r.indexOf,y=r.lastIndexOf,b=Array.isArray,w=Object.keys,E=s.bind,S=function(e){return new P(e)};typeof exports!="undefined"?(typeof module!="undefined"&&module.exports&&(exports=module.exports=S),exports._=S):e._=S,S.VERSION="1.3.3";var x=S.each=S.forEach=function(e,t,r){if(e==null)return;if(l&&e.forEach===l)e.forEach(t,r);else if(e.length===+e.length){for(var i=0,s=e.length;i<s;i++)if(i in e&&t.call(r,e[i],i,e)===n)return}else for(var o in e)if(S.has(e,o)&&t.call(r,e[o],o,e)===n)return};S.map=S.collect=function(e,t,n){var r=[];return e==null?r:c&&e.map===c?e.map(t,n):(x(e,function(e,i,s){r[r.length]=t.call(n,e,i,s)}),e.length===+e.length&&(r.length=e.length),r)},S.reduce=S.foldl=S.inject=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(h&&e.reduce===h)return r&&(t=S.bind(t,r)),i?e.reduce(t,n):e.reduce(t);x(e,function(e,s,o){i?n=t.call(r,n,e,s,o):(n=e,i=!0)});if(!i)throw new TypeError("Reduce of empty array with no initial value");return n},S.reduceRight=S.foldr=function(e,t,n,r){var i=arguments.length>2;e==null&&(e=[]);if(p&&e.reduceRight===p)return r&&(t=S.bind(t,r)),i?e.reduceRight(t,n):e.reduceRight(t);var s=S.toArray(e).reverse();return r&&!i&&(t=S.bind(t,r)),i?S.reduce(s,t,n,r):S.reduce(s,t)},S.find=S.detect=function(e,t,n){var r;return T(e,function(e,i,s){if(t.call(n,e,i,s))return r=e,!0}),r},S.filter=S.select=function(e,t,n){var r=[];return e==null?r:d&&e.filter===d?e.filter(t,n):(x(e,function(e,i,s){t.call(n,e,i,s)&&(r[r.length]=e)}),r)},S.reject=function(e,t,n){var r=[];return e==null?r:(x(e,function(e,i,s){t.call(n,e,i,s)||(r[r.length]=e)}),r)},S.every=S.all=function(e,t,r){var i=!0;return e==null?i:v&&e.every===v?e.every(t,r):(x(e,function(e,s,o){if(!(i=i&&t.call(r,e,s,o)))return n}),!!i)};var T=S.some=S.any=function(e,t,r){t||(t=S.identity);var i=!1;return e==null?i:m&&e.some===m?e.some(t,r):(x(e,function(e,s,o){if(i||(i=t.call(r,e,s,o)))return n}),!!i)};S.include=S.contains=function(e,t){var n=!1;return e==null?n:g&&e.indexOf===g?e.indexOf(t)!=-1:(n=T(e,function(e){return e===t}),n)},S.invoke=function(e,t){var n=o.call(arguments,2);return S.map(e,function(e){return(S.isFunction(t)?t||e:e[t]).apply(e,n)})},S.pluck=function(e,t){return S.map(e,function(e){return e[t]})},S.max=function(e,t,n){if(!t&&S.isArray(e)&&e[0]===+e[0])return Math.max.apply(Math,e);if(!t&&S.isEmpty(e))return-Infinity;var r={computed:-Infinity};return x(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o>=r.computed&&(r={value:e,computed:o})}),r.value},S.min=function(e,t,n){if(!t&&S.isArray(e)&&e[0]===+e[0])return Math.min.apply(Math,e);if(!t&&S.isEmpty(e))return Infinity;var r={computed:Infinity};return x(e,function(e,i,s){var o=t?t.call(n,e,i,s):e;o<r.computed&&(r={value:e,computed:o})}),r.value},S.shuffle=function(e){var t=[],n;return x(e,function(e,r,i){n=Math.floor(Math.random()*(r+1)),t[r]=t[n],t[n]=e}),t},S.sortBy=function(e,t,n){var r=S.isFunction(t)?t:function(e){return e[t]};return S.pluck(S.map(e,function(e,t,i){return{value:e,criteria:r.call(n,e,t,i)}}).sort(function(e,t){var n=e.criteria,r=t.criteria;return n===void 0?1:r===void 0?-1:n<r?-1:n>r?1:0}),"value")},S.groupBy=function(e,t){var n={},r=S.isFunction(t)?t:function(e){return e[t]};return x(e,function(e,t){var i=r(e,t);(n[i]||(n[i]=[])).push(e)}),n},S.sortedIndex=function(e,t,n){n||(n=S.identity);var r=0,i=e.length;while(r<i){var s=r+i>>1;n(e[s])<n(t)?r=s+1:i=s}return r},S.toArray=function(e){return e?S.isArray(e)?o.call(e):S.isArguments(e)?o.call(e):e.toArray&&S.isFunction(e.toArray)?e.toArray():S.values(e):[]},S.size=function(e){return S.isArray(e)?e.length:S.keys(e).length},S.first=S.head=S.take=function(e,t,n){return t!=null&&!n?o.call(e,0,t):e[0]},S.initial=function(e,t,n){return o.call(e,0,e.length-(t==null||n?1:t))},S.last=function(e,t,n){return t!=null&&!n?o.call(e,Math.max(e.length-t,0)):e[e.length-1]},S.rest=S.tail=function(e,t,n){return o.call(e,t==null||n?1:t)},S.compact=function(e){return S.filter(e,function(e){return!!e})},S.flatten=function(e,t){return S.reduce(e,function(e,n){return S.isArray(n)?e.concat(t?n:S.flatten(n)):(e[e.length]=n,e)},[])},S.without=function(e){return S.difference(e,o.call(arguments,1))},S.uniq=S.unique=function(e,t,n){var r=n?S.map(e,n):e,i=[];return e.length<3&&(t=!0),S.reduce(r,function(n,r,s){if(t?S.last(n)!==r||!n.length:!S.include(n,r))n.push(r),i.push(e[s]);return n},[]),i},S.union=function(){return S.uniq(S.flatten(arguments,!0))},S.intersection=S.intersect=function(e){var t=o.call(arguments,1);return S.filter(S.uniq(e),function(e){return S.every(t,function(t){return S.indexOf(t,e)>=0})})},S.difference=function(e){var t=S.flatten(o.call(arguments,1),!0);return S.filter(e,function(e){return!S.include(t,e)})},S.zip=function(){var e=o.call(arguments),t=S.max(S.pluck(e,"length")),n=new Array(t);for(var r=0;r<t;r++)n[r]=S.pluck(e,""+r);return n},S.indexOf=function(e,t,n){if(e==null)return-1;var r,i;if(n)return r=S.sortedIndex(e,t),e[r]===t?r:-1;if(g&&e.indexOf===g)return e.indexOf(t);for(r=0,i=e.length;r<i;r++)if(r in e&&e[r]===t)return r;return-1},S.lastIndexOf=function(e,t){if(e==null)return-1;if(y&&e.lastIndexOf===y)return e.lastIndexOf(t);var n=e.length;while(n--)if(n in e&&e[n]===t)return n;return-1},S.range=function(e,t,n){arguments.length<=1&&(t=e||0,e=0),n=arguments[2]||1;var r=Math.max(Math.ceil((t-e)/n),0),i=0,s=new Array(r);while(i<r)s[i++]=e,e+=n;return s};var N=function(){};S.bind=function(t,n){var r,i;if(t.bind===E&&E)return E.apply(t,o.call(arguments,1));if(!S.isFunction(t))throw new TypeError;return i=o.call(arguments,2),r=function(){if(this instanceof r){N.prototype=t.prototype;var e=new N,s=t.apply(e,i.concat(o.call(arguments)));return Object(s)===s?s:e}return t.apply(n,i.concat(o.call(arguments)))}},S.bindAll=function(e){var t=o.call(arguments,1);return t.length==0&&(t=S.functions(e)),x(t,function(t){e[t]=S.bind(e[t],e)}),e},S.memoize=function(e,t){var n={};return t||(t=S.identity),function(){var r=t.apply(this,arguments);return S.has(n,r)?n[r]:n[r]=e.apply(this,arguments)}},S.delay=function(e,t){var n=o.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},S.defer=function(e){return S.delay.apply(S,[e,1].concat(o.call(arguments,1)))},S.throttle=function(e,t){var n,r,i,s,o,u,a=S.debounce(function(){o=s=!1},t);return function(){n=this,r=arguments;var f=function(){i=null,o&&e.apply(n,r),a()};return i||(i=setTimeout(f,t)),s?o=!0:u=e.apply(n,r),a(),s=!0,u}},S.debounce=function(e,t,n){var r;return function(){var i=this,s=arguments,o=function(){r=null,n||e.apply(i,s)};n&&!r&&e.apply(i,s),clearTimeout(r),r=setTimeout(o,t)}},S.once=function(e){var t=!1,n;return function(){return t?n:(t=!0,n=e.apply(this,arguments))}},S.wrap=function(e,t){return function(){var n=[e].concat(o.call(arguments,0));return t.apply(this,n)}},S.compose=function(){var e=arguments;return function(){var t=arguments;for(var n=e.length-1;n>=0;n--)t=[e[n].apply(this,t)];return t[0]}},S.after=function(e,t){return e<=0?t():function(){if(--e<1)return t.apply(this,arguments)}},S.keys=w||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var n in e)S.has(e,n)&&(t[t.length]=n);return t},S.values=function(e){return S.map(e,S.identity)},S.functions=S.methods=function(e){var t=[];for(var n in e)S.isFunction(e[n])&&t.push(n);return t.sort()},S.extend=function(e){return x(o.call(arguments,1),function(t){for(var n in t)e[n]=t[n]}),e},S.pick=function(e){var t={};return x(S.flatten(o.call(arguments,1)),function(n){n in e&&(t[n]=e[n])}),t},S.defaults=function(e){return x(o.call(arguments,1),function(t){for(var n in t)e[n]==null&&(e[n]=t[n])}),e},S.clone=function(e){return S.isObject(e)?S.isArray(e)?e.slice():S.extend({},e):e},S.tap=function(e,t){return t(e),e},S.isEqual=function(e,t){return C(e,t,[])},S.isEmpty=function(e){if(e==null)return!0;if(S.isArray(e)||S.isString(e))return e.length===0;for(var t in e)if(S.has(e,t))return!1;return!0},S.isElement=function(e){return!!e&&e.nodeType==1},S.isArray=b||function(e){return a.call(e)=="[object Array]"},S.isObject=function(e){return e===Object(e)},S.isArguments=function(e){return a.call(e)=="[object Arguments]"},S.isArguments(arguments)||(S.isArguments=function(e){return!!e&&!!S.has(e,"callee")}),S.isFunction=function(e){return a.call(e)=="[object Function]"},S.isString=function(e){return a.call(e)=="[object String]"},S.isNumber=function(e){return a.call(e)=="[object Number]"},S.isFinite=function(e){return S.isNumber(e)&&isFinite(e)},S.isNaN=function(e){return e!==e},S.isBoolean=function(e){return e===!0||e===!1||a.call(e)=="[object Boolean]"},S.isDate=function(e){return a.call(e)=="[object Date]"},S.isRegExp=function(e){return a.call(e)=="[object RegExp]"},S.isNull=function(e){return e===null},S.isUndefined=function(e){return e===void 0},S.has=function(e,t){return f.call(e,t)},S.noConflict=function(){return e._=t,this},S.identity=function(e){return e},S.times=function(e,t,n){for(var r=0;r<e;r++)t.call(n,r)},S.escape=function(e){return(""+e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;")},S.result=function(e,t){if(e==null)return null;var n=e[t];return S.isFunction(n)?n.call(e):n},S.mixin=function(e){x(S.functions(e),function(t){B(t,S[t]=e[t])})};var k=0;S.uniqueId=function(e){var t=k++;return e?e+t:t},S.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var L=/.^/,A={"\\":"\\","'":"'",r:"\r",n:"\n",t:"	",u2028:"\u2028",u2029:"\u2029"};for(var O in A)A[A[O]]=O;var M=/\\|'|\r|\n|\t|\u2028|\u2029/g,_=/\\(\\|'|r|n|t|u2028|u2029)/g,D=function(e){return e.replace(_,function(e,t){return A[t]})};S.template=function(e,t,n){n=S.defaults(n||{},S.templateSettings);var r="__p+='"+e.replace(M,function(e){return"\\"+A[e]}).replace(n.escape||L,function(e,t){return"'+\n_.escape("+D(t)+")+\n'"}).replace(n.interpolate||L,function(e,t){return"'+\n("+D(t)+")+\n'"}).replace(n.evaluate||L,function(e,t){return"';\n"+D(t)+"\n;__p+='"})+"';\n";n.variable||(r="with(obj||{}){\n"+r+"}\n"),r="var __p='';var print=function(){__p+=Array.prototype.join.call(arguments, '')};\n"+r+"return __p;\n";var i=new Function(n.variable||"obj","_",r);if(t)return i(t,S);var s=function(e){return i.call(this,e,S)};return s.source="function("+(n.variable||"obj")+"){\n"+r+"}",s},S.chain=function(e){return S(e).chain()};var P=function(e){this._wrapped=e};S.prototype=P.prototype;var H=function(e,t){return t?S(e).chain():e},B=function(e,t){P.prototype[e]=function(){var e=o.call(arguments);return u.call(e,this._wrapped),H(t.apply(S,e),this._chain)}};S.mixin(S),x(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=r[e];P.prototype[e]=function(){var n=this._wrapped;t.apply(n,arguments);var r=n.length;return(e=="shift"||e=="splice")&&r===0&&delete n[0],H(n,this._chain)}}),x(["concat","join","slice"],function(e){var t=r[e];P.prototype[e]=function(){return H(t.apply(this._wrapped,arguments),this._chain)}}),P.prototype.chain=function(){return this._chain=!0,this},P.prototype.value=function(){return this._wrapped},typeof define=="function"&&define.amd&&define("underscore",function(){var e=S;return e._=S,e})}.call(this),function(){function parseUri(e){var t=parseUri.options,n=t.parser[t.strictMode?"strict":"loose"].exec(e),r={},i=14;while(i--)r[t.key[i]]=n[i]||"";return r[t.q.name]={},r[t.key[12]].replace(t.q.parser,function(e,n,i){n&&(r[t.q.name][n]=i)}),r}function getHost(e){if(/http(s?):/.test(e)){var t=parseUri(e);t.remote=!0;if(t.user||t.password)t.auth={username:t.user,password:t.password};var n=t.path.replace(/(^\/|\/$)/g,"").split("/");return t.db=n.pop(),t.path=n.join("/"),t}return{host:"",path:"/",db:e,auth:!1}}function genDBUrl(e,t){if(e.remote){var n=e.path?"/":"";return e.protocol+"://"+e.host+":"+e.port+"/"+e.path+n+e.db+"/"+t}return"/"+e.db+"/"+t}function genUrl(e,t){return e.remote?e.protocol+"://"+e.host+":"+e.port+"/"+t:"/"+t}function quote(e){return"'"+e+"'"}(function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var r=e,i=[];n=n||r.length;if(t)for(var s=0;s<t;s++)i[s]=r[0|Math.random()*n];else{var o;i[8]=i[13]=i[18]=i[23]="-",i[14]="4";for(var s=0;s<36;s++)i[s]||(o=0|Math.random()*16,i[s]=r[s==19?o&3|8:o])}return i.join("")},Math.uuidFast=function(){var t=e,n=new Array(36),r=0,i;for(var s=0;s<36;s++)s==8||s==13||s==18||s==23?n[s]="-":s==14?n[s]="4":(r<=2&&(r=33554432+Math.random()*16777216|0),i=r&15,r>>=4,n[s]=t[s==19?i&3|8:i]);return n.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)}).toUpperCase()}})();var Crypto={};(function(){Crypto.MD5=function(e){function t(e,t){return e<<t|e>>>32-t}function n(e,t){var n,r,i,s,o;return i=e&2147483648,s=t&2147483648,n=e&1073741824,r=t&1073741824,o=(e&1073741823)+(t&1073741823),n&r?o^2147483648^i^s:n|r?o&1073741824?o^3221225472^i^s:o^1073741824^i^s:o^i^s}function r(e,t,n){return e&t|~e&n}function i(e,t,n){return e&n|t&~n}function s(e,t,n){return e^t^n}function o(e,t,n){return t^(e|~n)}function u(e,i,s,o,u,a,f){return e=n(e,n(n(r(i,s,o),u),f)),n(t(e,a),i)}function a(e,r,s,o,u,a,f){return e=n(e,n(n(i(r,s,o),u),f)),n(t(e,a),r)}function f(e,r,i,o,u,a,f){return e=n(e,n(n(s(r,i,o),u),f)),n(t(e,a),r)}function l(e,r,i,s,u,a,f){return e=n(e,n(n(o(r,i,s),u),f)),n(t(e,a),r)}function c(e){var t,n=e.length,r=n+8,i=(r-r%64)/64,s=(i+1)*16,o=Array(s-1),u=0,a=0;while(a<n)t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|e.charCodeAt(a)<<u,a++;return t=(a-a%4)/4,u=a%4*8,o[t]=o[t]|128<<u,o[s-2]=n<<3,o[s-1]=n>>>29,o}function h(e){var t="",n="",r,i;for(i=0;i<=3;i++)r=e>>>i*8&255,n="0"+r.toString(16),t+=n.substr(n.length-2,2);return t}var p=Array(),d,v,m,g,y,b,w,E,S,x=7,T=12,N=17,C=22,k=5,L=9,A=14,O=20,M=4,_=11,D=16,P=23,H=6,B=10,j=15,F=21;p=c(e),b=1732584193,w=4023233417,E=2562383102,S=271733878;for(d=0;d<p.length;d+=16)v=b,m=w,g=E,y=S,b=u(b,w,E,S,p[d+0],x,3614090360),S=u(S,b,w,E,p[d+1],T,3905402710),E=u(E,S,b,w,p[d+2],N,606105819),w=u(w,E,S,b,p[d+3],C,3250441966),b=u(b,w,E,S,p[d+4],x,4118548399),S=u(S,b,w,E,p[d+5],T,1200080426),E=u(E,S,b,w,p[d+6],N,2821735955),w=u(w,E,S,b,p[d+7],C,4249261313),b=u(b,w,E,S,p[d+8],x,1770035416),S=u(S,b,w,E,p[d+9],T,2336552879),E=u(E,S,b,w,p[d+10],N,4294925233),w=u(w,E,S,b,p[d+11],C,2304563134),b=u(b,w,E,S,p[d+12],x,1804603682),S=u(S,b,w,E,p[d+13],T,4254626195),E=u(E,S,b,w,p[d+14],N,2792965006),w=u(w,E,S,b,p[d+15],C,1236535329),b=a(b,w,E,S,p[d+1],k,4129170786),S=a(S,b,w,E,p[d+6],L,3225465664),E=a(E,S,b,w,p[d+11],A,643717713),w=a(w,E,S,b,p[d+0],O,3921069994),b=a(b,w,E,S,p[d+5],k,3593408605),S=a(S,b,w,E,p[d+10],L,38016083),E=a(E,S,b,w,p[d+15],A,3634488961),w=a(w,E,S,b,p[d+4],O,3889429448),b=a(b,w,E,S,p[d+9],k,568446438),S=a(S,b,w,E,p[d+14],L,3275163606),E=a(E,S,b,w,p[d+3],A,4107603335),w=a(w,E,S,b,p[d+8],O,1163531501),b=a(b,w,E,S,p[d+13],k,2850285829),S=a(S,b,w,E,p[d+2],L,4243563512),E=a(E,S,b,w,p[d+7],A,1735328473),w=a(w,E,S,b,p[d+12],O,2368359562),b=f(b,w,E,S,p[d+5],M,4294588738),S=f(S,b,w,E,p[d+8],_,2272392833),E=f(E,S,b,w,p[d+11],D,1839030562),w=f(w,E,S,b,p[d+14],P,4259657740),b=f(b,w,E,S,p[d+1],M,2763975236),S=f(S,b,w,E,p[d+4],_,1272893353),E=f(E,S,b,w,p[d+7],D,4139469664),w=f(w,E,S,b,p[d+10],P,3200236656),b=f(b,w,E,S,p[d+13],M,681279174),S=f(S,b,w,E,p[d+0],_,3936430074),E=f(E,S,b,w,p[d+3],D,3572445317),w=f(w,E,S,b,p[d+6],P,76029189),b=f(b,w,E,S,p[d+9],M,3654602809),S=f(S,b,w,E,p[d+12],_,3873151461),E=f(E,S,b,w,p[d+15],D,530742520),w=f(w,E,S,b,p[d+2],P,3299628645),b=l(b,w,E,S,p[d+0],H,4096336452),S=l(S,b,w,E,p[d+7],B,1126891415),E=l(E,S,b,w,p[d+14],j,2878612391),w=l(w,E,S,b,p[d+5],F,4237533241),b=l(b,w,E,S,p[d+12],H,1700485571),S=l(S,b,w,E,p[d+3],B,2399980690),E=l(E,S,b,w,p[d+10],j,4293915773),w=l(w,E,S,b,p[d+1],F,2240044497),b=l(b,w,E,S,p[d+8],H,1873313359),S=l(S,b,w,E,p[d+15],B,4264355552),E=l(E,S,b,w,p[d+6],j,2734768916),w=l(w,E,S,b,p[d+13],F,1309151649),b=l(b,w,E,S,p[d+4],H,4149444226),S=l(S,b,w,E,p[d+11],B,3174756917),E=l(E,S,b,w,p[d+2],j,718787259),w=l(w,E,S,b,p[d+9],F,3951481745),b=n(b,v),w=n(w,m),E=n(E,g),S=n(S,y);var I=h(b)+h(w)+h(E)+h(S);return I.toLowerCase()}})(),function(){if(!Object.defineProperty||!function(){try{return Object.defineProperty({},"x",{}),!0}catch(e){return!1}}()){var e=Object.defineProperty;Object.defineProperty=function(t,n,r){"use strict";if(e)try{return e(t,n,r)}catch(i){}if(t!==Object(t))throw new TypeError("Object.defineProperty called on non-object");return Object.prototype.__defineGetter__&&"get"in r&&Object.prototype.__defineGetter__.call(t,n,r.get),Object.prototype.__defineSetter__&&"set"in r&&Object.prototype.__defineSetter__.call(t,n,r.set),"value"in r&&(t[n]=r.value),t}}}(),Object.keys||(Object.keys=function(e){if(e!==Object(e))throw new TypeError("Object.keys called on non-object");var t=[],n;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}),Array.prototype.forEach||(Array.prototype.forEach=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;var r=arguments[1],i;for(i=0;i<n;i++)i in t&&e.call(r,t[i],i,t)}),Array.prototype.map||(Array.prototype.map=function(e){"use strict";if(this===void 0||this===null)throw new TypeError;var t=Object(this),n=t.length>>>0;if(typeof e!="function")throw new TypeError;var r=[];r.length=n;var i=arguments[1],s;for(s=0;s<n;s++)s in t&&(r[s]=e.call(i,t[s],s,t));return r}),"use strict";var Pouch=function Pouch(e,t,n){if(!(this instanceof Pouch))return new Pouch(e,t,n);if(typeof t=="function"||typeof t=="undefined")n=t,t={};typeof e=="object"&&(t=e,e=undefined);var r=Pouch.parseAdapter(t.name||e);t.name=t.name||r.name,t.adapter=t.adapter||r.adapter;if(!Pouch.adapters[t.adapter])throw"Adapter is missing";if(!Pouch.adapters[t.adapter].valid())throw"Invalid Adapter";var i=Pouch.adapters[t.adapter](t,function(e,t){if(e){n&&n(e);return}for(var r in Pouch.plugins){var i=Pouch.plugins[r](t);for(var s in i)s in t||(t[s]=i[s])}n(null,t)});for(var s in i)this[s]=i[s]};Pouch.DEBUG=!1,Pouch.adapters={},Pouch.plugins={},Pouch.parseAdapter=function(e){var t=e.match(/([a-z\-]*):\/\/(.*)/);if(t){e=/http(s?)/.test(t[1])?t[1]+"://"+t[2]:t[2];var n=t[1];if(!Pouch.adapters[n].valid())throw"Invalid adapter";return{name:e,adapter:t[1]}}var r={idb:1,leveldb:2,websql:3,http:4,https:4},i=Object.keys(Pouch.adapters).sort(function(e,t){return r[e]-r[t]})[0];return{name:e,adapter:i}},Pouch.destroy=function(e,t){for(var n in Pouch.plugins)Pouch.plugins[n]._delete(e);var r=Pouch.parseAdapter(e);Pouch.adapters[r.adapter].destroy(r.name,t)},Pouch.adapter=function(e,t){t.valid()&&(Pouch.adapters[e]=t)},Pouch.plugin=function(e,t){Pouch.plugins[e]=t},Pouch.Errors={MISSING_BULK_DOCS:{status:400,error:"bad_request",reason:"Missing JSON list of 'docs'"},MISSING_DOC:{status:404,error:"not_found",reason:"missing"},REV_CONFLICT:{status:409,error:"conflict",reason:"Document update conflict"},INVALID_ID:{status:400,error:"invalid_id",reason:"_id field must contain a string"},MISSING_ID:{status:412,error:"missing_id",reason:"_id is required for puts"},RESERVED_ID:{status:400,error:"bad_request",reason:"Only reserved document ids may start with underscore."},NOT_OPEN:{status:412,error:"precondition_failed",reason:"Database not open so cannot close"},UNKNOWN_ERROR:{status:500,error:"unknown_error",reason:"Database encountered an unknown error"},INVALID_REQUEST:{status:400,error:"invalid_request",reason:"Request was invalid"}};if(typeof module!="undefined"&&module.exports){global.Pouch=Pouch,Pouch.merge=require("./pouch.merge.js").merge,Pouch.collate=require("./pouch.collate.js").collate,Pouch.replicate=require("./pouch.replicate.js").replicate,Pouch.utils=require("./pouch.utils.js"),module.exports=Pouch;var adapters=["leveldb","http"];adapters.map(function(e){var t="./adapters/pouch."+e+".js";require(t)}),require("./plugins/pouchdb.mapreduce.js")}else this.Pouch=Pouch;(function(){typeof module!="undefined"&&module.exports&&(module.exports=Pouch),Pouch.collate=function(i,s){var o=r(i),u=r(s);if(o-u!==0)return o-u;if(i===null)return 0;if(typeof i=="number")return i-s;if(typeof i=="boolean")return i<s?-1:1;if(typeof i=="string")return e(i,s);if(Array.isArray(i))return n(i,s);if(typeof i=="object")return t(i,s)};var e=function(e,t){return e===t?0:e>t?1:-1},t=function(e,t){var n=Object.keys(e),r=Object.keys(t),i=Math.min(n.length,r.length);for(var s=0;s<i;s++){var o=Pouch.collate(n[s],r[s]);if(o!==0)return o;o=Pouch.collate(e[n[s]],t[r[s]]);if(o!==0)return o}return n.length===r.length?0:n.length>r.length?1:-1},n=function(e,t){var n=Math.min(e.length,t.length);for(var r=0;r<n;r++){var i=Pouch.collate(e[r],t[r]);if(i!==0)return i}return e.length===t.length?0:e.length>t.length?1:-1},r=function(e){var t=["boolean","number","string","object"];if(t.indexOf(typeof e)!==-1)return e===null?1:t.indexOf(typeof e)+2;if(Array.isArray(e))return 4.5}}).call(this),function(){function n(e){var t=[e.shift(),[]],n=t;while(e.length)nleaf=[e.shift(),[]],n[1].push(nleaf),n=nleaf;return t}function r(e,t){var r=rootToLeaf(e).map(function(e){var r=e.ids.slice(-t);return{pos:e.pos+(e.ids.length-r.length),ids:n(r)}});return r.reduce(function(e,t,n,r){return s(e,t,!0).tree},[r.shift()])}function i(e,t){var n=[{tree1:e,tree2:t}],r=!1;while(n.length>0){var i=n.pop(),s=i.tree1,o=i.tree2;for(var u=0;u<o[1].length;u++){if(!s[1][0]){r="new_leaf",s[1][0]=o[1][u];continue}var a=!1;for(var f=0;f<s[1].length;f++)s[1][f][0]==o[1][u][0]&&(n.push({tree1:s[1][f],tree2:o[1][u]}),a=!0);a||(r="new_branch",s[1].push(o[1][u]),s[1].sort())}}return{conflicts:r,tree:e}}function s(e,t,n){var r=[],s=!1,o=!1,u,a;return e.length?(e.forEach(function(e){if(e.pos===t.pos&&e.ids[0]===t.ids[0])u=i(e.ids,t.ids),r.push({pos:e.pos,ids:u.tree}),s=s||u.conflicts,o=!0;else if(n!==!0){var a=e.pos<t.pos?e:t,f=e.pos<t.pos?t:e,l=f.pos-a.pos,c=[],h=[];h.push({ids:a.ids,diff:l,parent:null,parentIdx:null});while(h.length>0){var p=h.pop();if(p.diff==0){p.ids[0]==f.ids[0]&&c.push(p);continue}if(!p.ids)continue;p.ids[1].forEach(function(e,t){h.push({ids:e,diff:p.diff-1,parent:p.ids,parentIdx:t})})}var d=c[0];d?(u=i(d.ids,f.ids),d.parent[1][d.parentIdx]=u.tree,r.push({pos:a.pos,ids:a.ids}),s=s||u.conflicts,o=!0):r.push(e)}else r.push(e)}),o||r.push(t),r.sort(function(e,t){return e.pos-t.pos}),{tree:r,conflicts:s||"internal_node"}):{tree:[t],conflicts:"new_leaf"}}if(typeof module!="undefined"&&module.exports){module.exports=Pouch;var e=require("./pouch.utils.js");for(var t in e)global[t]=e[t]}Pouch.merge=function(e,t,n){e=extend(!0,[],e),t=extend(!0,{},t);var i=s(e,t);return{tree:r(i.tree,n),conflicts:i.conflicts}},Pouch.merge.winningRev=function(e){var t=e.deletions||{},n=[];return traverseRevTree(e.rev_tree,function(e,t,r){e&&n.push({pos:t,id:r})}),n.forEach(function(e){e.deleted=e.id in t}),n.sort(function(e,t){return e.deleted!==t.deleted?e.deleted>t.deleted?1:-1:e.pos!==t.pos?t.pos-e.pos:e.id<t.id?1:-1}),n[0].pos+"-"+n[0].id}}.call(this),typeof module!="undefined"&&module.exports&&(module.exports=Pouch),function(){function e(e,t,n,r,i){fetchCheckpoint(e,t,n,function(s){function h(){u&&a===0&&(c.end_time=new Date,writeCheckpoint(e,t,n,f,function(){call(r,null,c)}))}var o=[],u=!1,a=0,f=s,l=n.continuous||!1,c={ok:!0,start_time:new Date,docs_read:0,docs_written:0};if(i.cancelled)return;var p={continuous:l,since:s,style:"all_docs",onChange:function(s){f=s.seq,o.push(s),c.docs_read++,a++;var u={};u[s.id]=s.changes.map(function(e){return e.rev}),t.revsDiff(u,function(s,o){if(s){l&&i.cancel(),call(r,s,null);return}if(Object.keys(o).length===0){a--,h();return}for(var u in o)o[u].missing.map(function(r){e.get(u,{revs:!0,rev:r,attachments:!0},function(e,r){t.bulkDocs({docs:[r]},{new_edits:!1},function(){n.onChange&&n.onChange.apply(this,[c]),c.docs_written++,a--,h()})})})})},complete:function(e,t){u=!0,h()}};n.filter&&(p.filter=n.filter),n.query_params&&(p.query_params=n.query_params);var d=e.changes(p);n.continuous&&(i.cancel=d.cancel)})}function t(e,t){if(typeof e=="string")return new Pouch(e,t);t(null,e)}Pouch.replicate=function(n,r,i,s){i instanceof Function&&(s=i,i={}),i===undefined&&(i={});var o=function(){this.cancelled=!1,this.cancel=function(){this.cancelled=!0}},u=new o;return t(n,function(n,o){if(n)return call(s,n);t(r,function(t,n){if(t)return call(s,t);e(o,n,i,s,u)})}),u}}.call(this);var call=function(e){var t=Array.prototype.slice.call(arguments,1);typeof e==typeof Function&&e.apply(this,t)},yankError=function(e){return function(t,n){t||n[0].error?call(e,t||n[0]):call(e,null,n[0])}},isAttachmentId=function(e){return/\//.test(e)&&!/^_local/.test(e)&&!/^_design/.test(e)},parseDocId=function(e){var t=typeof e=="string"&&!/^_(design|local)\//.test(e)?e.split("/"):[e];return{docId:t[0],attachmentId:t.splice(1).join("/").replace(/^\/+/,"")}},isDeleted=function(e,t){return!e||!e.deletions?!1:(t||(t=Pouch.merge.winningRev(e)),t.indexOf("-")>=0&&(t=t.split("-")[1]),e.deletions[t]===!0)},isValidId=function(e){return/^_/.test(e)?/^_(design|local)/.test(e):!0},parseDoc=function(e,t){var n=null;if(e._id){var r=parseDocId(e._id);if(r.attachmentId!==""){var i=btoa(JSON.stringify(e));e={_id:r.docId},e._attachments||(e._attachments={}),e._attachments[r.attachmentId]={content_type:"application/json",data:i}}}if(t){e._id||(e._id=Math.uuid());var s=Math.uuid(32,16).toLowerCase(),o;if(e._rev){var u=/^(\d+)-(.+)$/.exec(e._rev);if(!u)throw"invalid value for property '_rev'";e._rev_tree=[{pos:parseInt(u[1],10),ids:[u[2],[[s,[]]]]}],o=parseInt(u[1],10)+1}else e._rev_tree=[{pos:1,ids:[s,[]]}],o=1}else{e._revisions&&(e._rev_tree=[{pos:e._revisions.start-e._revisions.ids.length+1,ids:e._revisions.ids.reduce(function(e,t){return e===null?[t,[]]:[t,[e]]},null)}],o=e._revisions.start,s=e._revisions.ids[0]);if(!e._rev_tree){var u=/^(\d+)-(.+)$/.exec(e._rev);o=parseInt(u[1],10),s=u[2],e._rev_tree=[{pos:parseInt(u[1],10),ids:[u[2],[]]}]}}return typeof e._id!="string"?n=Pouch.Errors.INVALID_ID:isValidId(e._id)||(n=Pouch.Errors.RESERVED_ID),e._id=decodeURIComponent(e._id),e._rev=[o,s].join("-"),n?n:Object.keys(e).reduce(function(t,n){return/^_/.test(n)&&n!=="_attachments"?t.metadata[n.slice(1)]=e[n]:t.data[n]=e[n],t},{metadata:{},data:{}})},compareRevs=function(e,t){return e.id!==t.id?e.id<t.id?-1:1:e.deleted^t.deleted?e.deleted?-1:1:e.rev_tree[0].pos===t.rev_tree[0].pos?e.rev_tree[0].ids<t.rev_tree[0].ids?-1:1:e.rev_tree[0].start<t.rev_tree[0].start?-1:1},traverseRevTree=function(e,t){var n=[];e.forEach(function(e){n.push({pos:e.pos,ids:e.ids})});while(n.length>0){var r=n.pop(),i=r.pos,s=r.ids,o=t(s[1].length==0,i,s[0],r.ctx);s[1].forEach(function(e){n.push({pos:i+1,ids:e,ctx:o})})}},collectRevs=function(e){var t=[];return traverseRevTree([e],function(e,n,r){t.push({rev:n+"-"+r,status:"available"})}),t},collectLeaves=function(e){var t=[];return traverseRevTree(e,function(e,n,r){e&&t.unshift({rev:n+"-"+r,pos:n})}),t.sort(function(e,t){return t.pos-e.pos}),t.map(function(e){delete e.pos}),t},collectConflicts=function(e){var t=collectLeaves(e);return t.shift(),t.map(function(e){return e.rev})},fetchCheckpoint=function(e,t,n,r){var i="";typeof n.filter!="undefined"&&(i=n.filter.toString());var s=Crypto.MD5(e.id()+t.id()+i);e.get("_local/"+s,function(e,t){e&&e.status===404?r(0):r(t.last_seq)})},writeCheckpoint=function(e,t,n,r,i){var s="";typeof n.filter!="undefined"&&(s=n.filter.toString());var o={_id:"_local/"+Crypto.MD5(e.id()+t.id()+s),last_seq:r};e.get(o._id,function(t,n){n&&n._rev&&(o._rev=n._rev),e.put(o,function(e,t){i()})})},arrayFirst=function(e,t){for(var n=0;n<e.length;n++)if(t(e[n],n)===!0)return e[n];return!1},filterChange=function(e){return function(t){if(e.filter&&!e.filter.call(this,t.doc))return;e.include_docs||delete t.doc,call(e.onChange,t)}},rootToLeaf=function(e){var t=[];return traverseRevTree(e,function(e,n,r,i){i=i?i.slice(0):[],i.push(r);if(e){var s=n+1-i.length;t.unshift({pos:s,ids:i})}return i}),t},ajax=function(t,n){typeof t=="function"&&(n=t,t={});var r={method:"GET",headers:{},json:!0,timeout:1e4};t=extend(!0,r,t);if(t.auth){var i=btoa(t.auth.username+":"+t.auth.password);t.headers.Authorization="Basic "+i}var s=function(e,n,r){!t.json&&typeof e!="string"?e=JSON.stringify(e):t.json&&typeof e=="string"&&(e=JSON.parse(e)),call(r,null,e,n)},o=function(e,t){var n,r=e.responseText?{status:e.status}:e;try{n=JSON.parse(e.responseText),r=extend(!0,{},r,n)}catch(i){}call(t,r)};if(typeof window!="undefined"&&window.XMLHttpRequest){var u,a=!1,f=new XMLHttpRequest;f.open(t.method,t.url),t.json&&(t.headers.Accept="application/json",t.headers["Content-Type"]="application/json",t.body&&typeof t.body!="string"&&(t.body=JSON.stringify(t.body)));for(var l in t.headers)f.setRequestHeader(l,t.headers[l]);"body"in t||(t.body=null);var c=function(){a=!0,f.abort(),call(o,f,n)};return f.onreadystatechange=function(){if(f.readyState!==4||a)return;clearTimeout(u),f.status>=200&&f.status<300?call(s,f.responseText,f,n):call(o,f,n)},t.timeout>0&&(u=setTimeout(c,t.timeout)),f.send(t.body),{abort:c}}return t.json&&(t.headers.Accept="application/json",t.headers["Content-Type"]="application/json"),request(t,function(e,r,i){if(e)return e.status=r?r.statusCode:400,call(o,e,n);var u=r.headers["content-type"],a=i||"";t.json&&typeof a!="object"&&(/json/.test(u)||/^[\s]*{/.test(a)&&/}[\s]*$/.test(a))&&(a=JSON.parse(a)),a.error?(a.status=r.statusCode,call(o,a,n)):call(s,a,r,n)})},class2type={},types=["Boolean","Number","String","Function","Array","Date","RegExp","Object","Error"];for(var i=0;i<types.length;i++){var typename=types[i];class2type["[object "+typename+"]"]=typename.toLowerCase()}var core_toString=class2type.toString,core_hasOwn=class2type.hasOwnProperty,type=function(e){return e===null?String(e):typeof e=="object"||typeof e=="function"?class2type[core_toString.call(e)]||"object":typeof e},isPlainObject=function(e){if(!e||type(e)!=="object"||e.nodeType||isWindow(e))return!1;try{if(e.constructor&&!core_hasOwn.call(e,"constructor")&&!core_hasOwn.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}var n;for(n in e);return n===undefined||core_hasOwn.call(e,n)},isFunction=function(e){return type(e)==="function"},isWindow=function(e){return e!=null&&e==e.window},isArray=Array.isArray||function(e){return type(e)==="array"},extend=function(){var e,t,n,r,i,s,o=arguments[0]||{},u=1,a=arguments.length,f=!1;typeof o=="boolean"&&(f=o,o=arguments[1]||{},u=2),typeof o!="object"&&!isFunction(o)&&(o={}),a===u&&(o=this,--u);for(;u<a;u++)if((e=arguments[u])!=null)for(t in e){n=o[t],r=e[t];if(o===r)continue;f&&r&&(isPlainObject(r)||(i=isArray(r)))?(i?(i=!1,s=n&&isArray(n)?n:[]):s=n&&isPlainObject(n)?n:{},o[t]=extend(f,s,r)):r!==undefined&&(o[t]=r)}return o},win=this,localJSON=function(){return win.localStorage?{set:function(e,t){localStorage.setItem(e,JSON.stringify(t))},get:function(e,t){try{return localStorage.getItem(e)===null?t:JSON.parse(localStorage.getItem(e)||"false")}catch(n){return t}},remove:function(e){localStorage.removeItem(e)}}:!1}();typeof btoa=="undefined"&&(btoa=function(e){return(new Buffer(unescape(encodeURIComponent(e)),"binary")).toString("base64")}),typeof atob=="undefined"&&(atob=function(e){return decodeURIComponent(escape((new Buffer(e,"base64")).toString("binary")))});if(typeof module!="undefined"&&module.exports){var crypto=require("crypto"),Crypto={MD5:function(e){return crypto.createHash("md5").update(e).digest("hex")}};request=require("request"),_=require("underscore"),$=_,module.exports={Crypto:Crypto,call:call,yankError:yankError,isAttachmentId:isAttachmentId,parseDocId:parseDocId,parseDoc:parseDoc,isDeleted:isDeleted,compareRevs:compareRevs,collectRevs:collectRevs,collectLeaves:collectLeaves,collectConflicts:collectConflicts,fetchCheckpoint:fetchCheckpoint,writeCheckpoint:writeCheckpoint,arrayFirst:arrayFirst,filterChange:filterChange,ajax:ajax,atob:atob,btoa:btoa,extend:extend,traverseRevTree:traverseRevTree,rootToLeaf:rootToLeaf,isPlainObject:isPlainObject,isArray:isArray}}var Changes=function(){var e={},t={};return window.addEventListener("storage",function(t){e.notify(t.key)}),e.addListener=function(e,n,r,i){t[e]||(t[e]={}),t[e][n]={db:r,opts:i}},e.removeListener=function(e,n){delete t[e][n]},e.clearListeners=function(e){delete t[e]},e.notify=function(e){if(!t[e])return;for(var n in t[e]){var r=t[e][n].opts;t[e][n].db.changes({include_docs:r.include_docs,conflicts:r.conflicts,continuous:!1,filter:r.filter,since:r.since,onChange:function(e){e.seq>r.since&&(r.since=e.seq,call(r.onChange,e))}})}},e};"use strict";var HTTP_TIMEOUT=1e4;parseUri.options={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};var HttpPouch=function(e,t){var n=getHost(e.name);e.auth&&(n.auth=e.auth);var r=genDBUrl(n,""),i={},s={list:[],get:function(e,t){typeof e=="function"&&(t=e,e={count:10});var r=function(e,n){!e&&"uuids"in n?(s.list=s.list.concat(n.uuids),call(t,null,"OK")):call(t,e||Pouch.Errors.UNKNOWN_ERROR)},i="?count="+e.count;ajax({auth:n.auth,method:"GET",url:genUrl(n,"_uuids")+i},r)}},o=function(){ajax({auth:n.auth,method:"PUT",url:r},function(e,s){e&&e.status===401?ajax({auth:n.auth,method:"HEAD",url:r},function(e,n){e?call(t,e):call(t,null,i)}):!e||e.status===412?call(t,null,i):call(t,Pouch.Errors.UNKNOWN_ERROR)})};return ajax({auth:n.auth,method:"GET",url:r},function(e,n){e?e.status===404?o():call(t,e):call(t,null,i)}),i.type=function(){return"http"},i.id=function(){return genDBUrl(n,"")},i.request=function(e,t){e.auth=n.auth,e.url=genDBUrl(n,e.url),ajax(e,t)},i.compact=function(e){ajax({auth:n.auth,url:genDBUrl(n,"_compact"),method:"POST"},e)},i.info=function(e){ajax({auth:n.auth,method:"GET",url:genDBUrl(n,"")},e)},i.get=function(e,t,r){typeof t=="function"&&(r=t,t={});var i=[];t.revs&&i.push("revs=true"),t.revs_info&&i.push("revs_info=true"),t.attachments&&i.push("attachments=true"),t.rev&&i.push("rev="+t.rev),t.conflicts&&i.push("conflicts="+t.conflicts),i=i.join("&"),i=i===""?"":"?"+i;var s={auth:n.auth,method:"GET",url:genDBUrl(n,e+i)},o=e.split("/");if(o.length>1&&o[0]!=="_design"&&o[0]!=="_local"||o.length>2&&o[0]==="_design"&&o[0]!=="_local")s.json=!1;ajax(s,function(e,t,n){if(e)return call(r,Pouch.Errors.MISSING_DOC);call(r,null,t,n)})},i.remove=function(e,t,r){typeof t=="function"&&(r=t,t={}),ajax({auth:n.auth,method:"DELETE",url:genDBUrl(n,e._id)+"?rev="+e._rev},r)},i.removeAttachment=function(t,r,i){ajax({auth:n.auth,method:"DELETE",url:genDBUrl(n,t)+"?rev="+r},i)},i.putAttachment=function(e,t,r,i,s){ajax({auth:n.auth,method:"PUT",url:genDBUrl(n,e)+"?rev="+t,headers:{"Content-Type":i},body:r},s)},i.put=function(e,t,r){typeof t=="function"&&(r=t,t={});if(!e||!("_id"in e))return call(r,Pouch.Errors.MISSING_ID);var i=[];t&&typeof t.new_edits!="undefined"&&i.push("new_edits="+t.new_edits),i=i.join("&"),i!==""&&(i="?"+i),ajax({auth:n.auth,method:"PUT",url:genDBUrl(n,e._id)+i,body:e},r)},i.post=function(e,t,n){typeof t=="function"&&(n=t,t={}),"_id"in e?i.put(e,t,n):s.list.length>0?(e._id=s.list.pop(),i.put(e,t,n)):s.get(function(r,o){if(r)return call(n,Pouch.Errors.UNKNOWN_ERROR);e._id=s.list.pop(),i.put(e,t,n)})},i.bulkDocs=function(e,t,r){typeof t=="function"&&(r=t,t={}),t||(t={}),typeof t.new_edits!="undefined"&&(e.new_edits=t.new_edits),ajax({auth:n.auth,method:"POST",url:genDBUrl(n,"_bulk_docs"),body:e},r)},i.allDocs=function(e,t){typeof e=="function"&&(t=e,e={});var r=[],i=undefined,s="GET";e.conflicts&&r.push("conflicts=true"),e.include_docs&&r.push("include_docs=true"),e.startkey&&r.push("startkey="+encodeURIComponent(JSON.stringify(e.startkey))),e.endkey&&r.push("endkey="+encodeURIComponent(JSON.stringify(e.endkey))),r=r.join("&"),r!==""&&(r="?"+r),typeof e.keys!="undefined"&&(s="POST",i=JSON.stringify({keys:e.keys})),ajax({auth:n.auth,method:s,url:genDBUrl(n,"_all_docs"+r),body:i},t)},i.changes=function(e){Pouch.DEBUG&&console.log(r+": Start Changes Feed: continuous="+e.continuous);var t=[],i;e.style&&t.push("style="+e.style),(e.include_docs||e.filter&&typeof e.filter=="function")&&t.push("include_docs=true"),e.continuous&&t.push("feed=longpoll"),e.conflicts&&t.push("conflicts=true"),e.descending&&t.push("descending=true"),e.filter&&typeof e.filter=="string"&&t.push("filter="+e.filter);if(e.query_params&&typeof e.query_params=="object")for(var s in e.query_params)e.query_params.hasOwnProperty(s)&&t.push(s+"="+e.query_params[s]);i="?",t.length>0&&(i+=t.join("&"));var o,u,a=function(t,r){var s={auth:n.auth,method:"GET",url:genDBUrl(n,"_changes"+i+"&since="+t),timeout:null};u=t;if(e.aborted)return;o=ajax(s,r)},f=10,l=0,c=function(t,n){n&&n.results&&n.results.forEach(function(t){var n=e.filter&&typeof e.filter=="function";if(e.aborted||n&&!e.filter.apply(this,[t.doc]))return;call(e.onChange,t)}),n&&n.last_seq&&(u=n.last_seq);if(e.continuous){t?l+=1:l=0;var r=1<<l,i=f*r,s=e.maximumWait||3e4;i>s&&call(e.complete,t||Pouch.Errors.UNKNOWN_ERROR,null),setTimeout(function(){a(u,c)},i)}else call(e.complete,null,n)};return a(e.since||0,c),{cancel:function(){Pouch.DEBUG&&console.log(r+": Cancel Changes Feed"),e.aborted=!0,o.abort()}}},i.revsDiff=function(e,t,r){typeof t=="function"&&(r=t,t={}),ajax({auth:n.auth,method:"POST",url:genDBUrl(n,"_revs_diff"),body:e},function(e,t){call(r,null,t)})},i.replicate={},i.replicate.from=function(e,t,n){return typeof t=="function"&&(n=t,t={}),Pouch.replicate(e,i,t,n)},i.replicate.to=function(e,t,n){return typeof t=="function"&&(n=t,t={}),Pouch.replicate(i,e,t,n)},i.close=function(e){call(e,null)},i};HttpPouch.destroy=function(e,t){var n=getHost(e);ajax({auth:n.auth,method:"DELETE",url:genDBUrl(n,"")},t)},HttpPouch.valid=function(){return!0};if(typeof module!="undefined"&&module.exports){var pouchdir="../";this.Pouch=require(pouchdir+"pouch.js"),this.ajax=Pouch.utils.ajax}Pouch.adapter("http",HttpPouch),Pouch.adapter("https",HttpPouch),window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB,window.IDBTransaction=window.IDBTransaction&&window.IDBTransaction.READ_WRITE?window.IDBTransaction:window.webkitIDBTransaction&&window.webkitIDBTransaction.READ_WRITE?window.webkitIDBTransaction:{READ_WRITE:"readwrite"},window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange,window.storageInfo=window.storageInfo||window.webkitStorageInfo,window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;var idbError=function(e){return function(t){call(e,{status:500,error:t.type,reason:t.target})}},IdbPouch=function(opts,callback){function sortByBulkSeq(e,t){return e._bulk_seq-t._bulk_seq}function toArray(e){return Array.prototype.slice.call(e||[],0)}function fileErrorHandler(e){console.error("File system error",e)}function deleteOrphanedFiles(e){api.allDocs({include_docs:!0},function(t,n){window.requestFileSystem(window.PERSISTENT,e,function(e){var t=e.root.createReader(),r=[],i=n.rows,s=function(){t.readEntries(function(e){if(!e.length)for(var t in r){var n=!1;for(var o in i)if(i[o].doc){var u=i[o].doc;if(u._attachments)for(var a in u._attachments)u._attachments[a].digest==r[t].name&&(n=!0);if(n)break}n||r[t].remove(function(){Pouch.DEBUG&&console.log("Removed orphaned attachment: "+r[t].name)},fileErrorHandler)}else r=r.concat(toArray(e)),s()},fileErrorHandler)};s()},fileErrorHandler)})}function writeAttachmentToFile(e,t,n){window.storageInfo.queryUsageAndQuota(window.PERSISTENT,function(r,i){var s=i;i==0?s=1048576e3:r/i>.8?deleteOrphanedFiles(i):r/i>.9&&(s=2*i),Pouch.DEBUG&&console.log("Current file quota: "+i+", current usage:"+r+", new quota will be: "+s),window.storageInfo.requestQuota(window.PERSISTENT,s,function(r){window.storageInfo.queryUsageAndQuota(window.PERSISTENT,function(r,i){window.requestFileSystem(window.PERSISTENT,i,function(r){r.root.getFile(e,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(e){Pouch.DEBUG&&console.log("Wrote attachment")},e.onerror=function(e){console.error("File write failed: "+e.toString())};var r=new Blob([t],{type:n});e.write(r)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)}function readAttachmentFromFile(e,t){window.storageInfo.queryUsageAndQuota(window.PERSISTENT,function(n,r){window.requestFileSystem(window.PERSISTENT,r,function(n){n.root.getFile(e,{},function(e){e.file(function(e){var n=new FileReader;n.onloadend=function(e){data=this.result,Pouch.DEBUG&&console.log("Read attachment"),t(data)},n.readAsBinaryString(e)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)},fileErrorHandler)}var POUCH_VERSION=1,DOC_STORE="document-store",BY_SEQ_STORE="by-sequence",ATTACH_STORE="attach-store",META_STORE="meta-store",name=opts.name,req=indexedDB.open(name,POUCH_VERSION),meta={id:"meta-store",updateSeq:0},instanceId=null,storeAttachmentsInIDB=!0,api={},idb=null;return Pouch.DEBUG&&console.log(name+": Open Database"),req.onupgradeneeded=function(e){var t=e.target.result;t.createObjectStore(DOC_STORE,{keyPath:"id"}).createIndex("seq","seq",{unique:!0}),t.createObjectStore(BY_SEQ_STORE,{autoIncrement:!0}).createIndex("_rev","_rev",{unique:!0}),t.createObjectStore(ATTACH_STORE,{keyPath:"digest"}),t.createObjectStore(META_STORE,{keyPath:"id",autoIncrement:!1})},req.onsuccess=function(e){idb=e.target.result;var t=idb.transaction([META_STORE],IDBTransaction.READ_WRITE);idb.onversionchange=function(){idb.close()};if(idb.setVersion&&Number(idb.version)!==POUCH_VERSION){var n=idb.setVersion(POUCH_VERSION);n.onsuccess=function(t){function n(){r.onsuccess(e)}t.target.result.oncomplete=n,r.onupgradeneeded(e)};return}var r=t.objectStore(META_STORE).get("meta-store");r.onsuccess=function(e){var n,r;e.target.result&&(meta=e.target.result),name+"_id"in meta?instanceId=meta[name+"_id"]:(instanceId=Math.uuid(),meta[name+"_id"]=instanceId,n=t.objectStore(META_STORE).put(meta)),call(callback,null,api)}},req.onerror=idbError(callback),api.type=function(){return"idb"},api.id=function(){return instanceId},api.bulkDocs=function(t,n,r){function f(){if(!a.length)return;var e=a.shift(),t=m.objectStore(DOC_STORE).get(e.metadata.id);t.onsuccess=function(n){var r=n.target.result;r?h(r,e):p(e)}}function l(e){var t=[];u.sort(sortByBulkSeq),u.forEach(function(e){delete e._bulk_seq;if(e.error){t.push(e);return}var n=e.metadata,r=Pouch.merge.winningRev(n);t.push({ok:!0,id:n.id,rev:r});if(/_local/.test(n.id))return;IdbPouch.Changes.notify(name),localStorage[name]=localStorage[name]==="a"?"b":"a"}),call(r,null,t)}function c(e,t){function l(e){n||(e?(n=e,call(t,n)):r==s.length&&c())}function c(){var n=m.objectStore(BY_SEQ_STORE).put(e.data);n.onsuccess=function(n){Pouch.DEBUG&&console.log(name+": Wrote Document ",e.metadata.id),e.metadata.seq=n.target.result,delete e.metadata.rev;var r=m.objectStore(DOC_STORE).put(e.metadata);r.onsuccess=function(){u.push(e),call(t)}}}var n=null,r=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,meta.updateSeq++;var i=m.objectStore(META_STORE).put(meta);isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var s=e.data._attachments?Object.keys(e.data._attachments):[];for(var o in e.data._attachments)if(!e.data._attachments[o].stub){var a=e.data._attachments[o].data,f="md5-"+Crypto.MD5(a);delete e.data._attachments[o].data,e.data._attachments[o].digest=f,v(e,f,a,function(e){r++,l(e)})}else r++,l();s.length||c()}function h(e,t){var n=Pouch.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),r=isDeleted(e)&&isDeleted(t.metadata)||!isDeleted(e)&&i&&n.conflicts!=="new_leaf";if(r)return u.push(d(Pouch.Errors.REV_CONFLICT,t._bulk_seq)),f();t.metadata.rev_tree=n.tree,c(t,f)}function p(e){if("was_delete"in n&&isDeleted(e.metadata))return u.push(Pouch.Errors.MISSING_DOC),f();c(e,f)}function d(e,t){return e._bulk_seq=t,e}function v(e,t,n,r){if(storeAttachmentsInIDB){var i=m.objectStore(ATTACH_STORE),s=i.get(t).onsuccess=function(s){var o=[e.metadata.id,e.metadata.rev].join("@"),u={digest:t,body:n};s.target.result?s.target.result.refs&&(u.refs=s.target.result.refs,u.refs[o]=!0):(u.refs={},u.refs[o]=!0);var a=i.put(u).onsuccess=function(e){call(r)};a.onerror=a.ontimeout=idbError(r)};s.onerror=s.ontimeout=idbError(r)}else writeAttachmentToFile(t,n),call(r)}typeof n=="function"&&(r=n,n={}),n||(n={});if(!t.docs)return call(r,Pouch.Errors.MISSING_BULK_DOCS);var i="new_edits"in n?n.new_edits:!0,s=extend(!0,[],t.docs),o=s.map(function(e,t){var n=parseDoc(e,i);return n._bulk_seq=t,e._deleted&&(n.metadata.deletions||(n.metadata.deletions={}),n.metadata.deletions[e._rev.split("-")[1]]=!0),n}),u=[],a=[];o.forEach(function(e){if(e.error)return u.push(e);if(!a.length||e.metadata.id!==a[0].metadata.id)return a.unshift(e);u.push(d(Pouch.Errors.REV_CONFLICT,e._bulk_seq))});var m=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE,META_STORE],IDBTransaction.READ_WRITE);m.onerror=idbError(r),m.ontimeout=idbError(r),m.oncomplete=l,f()},api.get=function(t,n,r){typeof n=="function"&&(r=n,n={}),t=parseDocId(t);if(t.attachmentId!=="")return api.getAttachment(t,{decode:!0},r);var i,s=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly");s.oncomplete=function(){"error"in i?call(r,i):call(r,null,i)},s.objectStore(DOC_STORE).get(t.docId).onsuccess=function(e){var t=e.target.result;if(!e.target.result||isDeleted(t,n.rev)&&!n.rev){i=Pouch.Errors.MISSING_DOC;return}var r=Pouch.merge.winningRev(t),o=n.rev?n.rev:r,u=s.objectStore(BY_SEQ_STORE).index("_rev");u.get(o).onsuccess=function(e){var r=e.target.result;if(n.revs){var o=arrayFirst(rootToLeaf(t.rev_tree),function(e){return e.ids.indexOf(r._rev.split("-")[1])!==-1});o.ids.reverse(),r._revisions={start:o.pos+o.ids.length-1,ids:o.ids}}n.revs_info&&(r._revs_info=t.rev_tree.reduce(function(e,t){return e.concat(collectRevs(t))},[]));if(n.conflicts){var u=collectConflicts(t.rev_tree);u.length&&(r._conflicts=u)}if(n.attachments&&r._attachments){var a=Object.keys(r._attachments),f=0;a.forEach(function(e){api.getAttachment(r._id+"/"+e,{txn:s},function(t,n){r._attachments[e].data=n,++f===a.length&&(i=r)})})}else{if(r._attachments)for(var l in r._attachments)r._attachments[l].stub=!0;i=r}}}},api.getAttachment=function(e,t,n){t instanceof Function&&(n=t,t={}),typeof e=="string"&&(e=parseDocId(e));var r,i;"txn"in t?i=t.txn:(i=idb.transaction([DOC_STORE,BY_SEQ_STORE,ATTACH_STORE],"readonly"),i.oncomplete=function(){call(n,null,r)}),i.objectStore(DOC_STORE).get(e.docId).onsuccess=function(s){var o=s.target.result,u=i.objectStore(BY_SEQ_STORE);u.get(o.seq).onsuccess=function(s){function f(e){return t.decode&&(e=atob(e)),e}var o=s.target.result._attachments[e.attachmentId],u=o.digest,a=o.content_type;storeAttachmentsInIDB?i.objectStore(ATTACH_STORE).get(u).onsuccess=function(e){var i=e.target.result.body;r=f(i),"txn"in t&&call(n,null,r)}:readAttachmentFromFile(u,function(e){r=f(e),"txn"in t&&call(n,null,r)})}};return},api.put=function(e,t,n){return typeof t=="function"&&(n=t,t={}),!!e&&"_id"in e?api.bulkDocs({docs:[e]},t,yankError(n)):call(n,Pouch.Errors.MISSING_ID)},api.post=function(t,n,r){return typeof n=="function"&&(r=n,n={}),api.bulkDocs({docs:[t]},n,yankError(r))},api.putAttachment=function(t,n,r,i,s){t=parseDocId(t),api.get(t.docId,{attachments:!0},function(e,n){n._attachments||(n._attachments={}),n._attachments[t.attachmentId]={content_type:i,data:btoa(r)},api.put(n,s)})},api.remove=function(t,n,r){typeof n=="function"&&(r=n,n={}),n.was_delete=!0;var i=extend(!0,{},t);return i._deleted=!0,api.bulkDocs({docs:[i]},n,yankError(r))},api.removeAttachment=function(t,n,r){t=parseDocId(t),api.get(t.docId,function(e,i){if(e){call(r,e);return}if(i._rev!=n){call(r,Pouch.Errors.REV_CONFLICT);return}i._attachments||(i._attachments={}),delete i._attachments[t.attachmentId],api.put(i,r)})},api.allDocs=function(t,n){typeof t=="function"&&(n=t,t={});var r="startkey"in t?t.startkey:!1,i="endkey"in t?t.endkey:!1,s="descending"in t?t.descending:!1;s=s?"prev":null;var o=r&&i?IDBKeyRange.bound(r,i,!1,!1):r?IDBKeyRange.lowerBound(r,!0):i?IDBKeyRange.upperBound(i):null,u,a=idb.transaction([DOC_STORE,BY_SEQ_STORE],"readonly");a.oncomplete=function(){n(null,u)};var f=a.objectStore(DOC_STORE),l=s?f.openCursor(o,s):f.openCursor(o),c=[];l.onsuccess=function(e){function r(e,r){if(/_local/.test(e.id))return n["continue"]();if(!isDeleted(e)){var i={id:e.id,key:e.id,value:{rev:Pouch.merge.winningRev(e)}};t.include_docs&&(i.doc=r,i.doc._rev=Pouch.merge.winningRev(e),t.conflicts&&(i.doc._conflicts=collectConflicts(e.rev_tree))),c.push(i)}n["continue"]()}if(!e.target.result){u={total_rows:c.length,rows:c};return}var n=e.target.result;if(!t.include_docs)r(n.value);else{var i=a.objectStore(BY_SEQ_STORE);i.get(n.value.seq).onsuccess=function(e){r(n.value,e.target.result)}}}},api.info=function(t){var n=0,r,i=idb.transaction([DOC_STORE],"readonly");i.oncomplete=function(){t(null,r)},i.objectStore(DOC_STORE).openCursor().onsuccess=function(e){var t=e.target.result;if(!t){r={db_name:name,doc_count:n,update_seq:meta.updateSeq};return}t.value.deleted!==!0&&n++,t["continue"]()}},api.revsDiff=function(t,n,r){function u(e,n,u){t[u].map(function(e){var t=function(t){return t.rev!==e};if(!n||n._revs_info.every(t))o[u]||(o[u]={missing:[]}),o[u].missing.push(e)});if(++s===i.length)return call(r,null,o)}typeof n=="function"&&(r=n,n={});var i=Object.keys(t),s=0,o={};i.map(function(e){api.get(e,{revs_info:!0},function(t,n){u(t,n,e)})})},api.changes=function idb_changes(opts){function fetchChanges(){txn=idb.transaction([DOC_STORE,BY_SEQ_STORE]),txn.oncomplete=onTxnComplete;var e=descending?txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.since,!0),descending):txn.objectStore(BY_SEQ_STORE).openCursor(IDBKeyRange.lowerBound(opts.since,!0));e.onsuccess=onsuccess,e.onerror=onerror}function onsuccess(e){if(!e.target.result){opts.continuous&&!opts.cancelled&&IdbPouch.Changes.addListener(name,id,api,opts);for(var t=0,n=results.length;t<n;t++){var r=results[t];r&&dedupResults.push(r)}return!1}var i=e.target.result,s=i.value._id,o=resultIndices[s];if(o!==undefined)return results[o].seq=i.key,results.push(results[o]),results[o]=null,resultIndices[s]=results.length-1,i["continue"]();var u=txn.objectStore(DOC_STORE);u.get(i.value._id).onsuccess=function(e){var t=e.target.result;if(/_local/.test(t.id))return i["continue"]();var n=Pouch.merge.winningRev(t),r=txn.objectStore(BY_SEQ_STORE).index("_rev");r.get(n).onsuccess=function(e){var r=e.target.result,s=[{rev:n}];opts.style==="all_docs"&&(s=collectLeaves(t.rev_tree));var o={id:t.id,seq:i.key,changes:s,doc:r};isDeleted(t,n)&&(o.deleted=!0),opts.conflicts&&(o.doc._conflicts=collectConflicts(t.rev_tree));var u=o.id,a=resultIndices[u];a!==undefined&&(results[a]=null),results.push(o),resultIndices[u]=results.length-1,i["continue"]()}}}function onTxnComplete(){dedupResults.map(function(e){if(opts.filter&&!opts.filter.apply(this,[e.doc]))return;opts.include_docs||delete e.doc,e.seq>opts.since&&(opts.since=e.seq,call(opts.onChange,e))}),(!opts.continuous||opts.continuous&&!opts.cancelled)&&call(opts.complete,null,{results:dedupResults})}function onerror(e){opts.continuous&&!opts.cancelled?IdbPouch.Changes.addListener(name,id,opts):call(opts.complete)}opts.since||(opts.since=0),Pouch.DEBUG&&console.log(name+": Start Changes Feed: continuous="+opts.continuous);var descending="descending"in opts?opts.descending:!1;descending=descending?"prev":null;var results=[],resultIndices={},dedupResults=[],id=name+":"+Math.uuid(),txn;if(opts.filter&&typeof opts.filter=="string"){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,fetchChanges()})}else fetchChanges();if(opts.continuous)return{cancel:function(){Pouch.DEBUG&&console.log(name+": Cancel Changes Feed"),opts.cancelled=!0,IdbPouch.Changes.removeListener(name,id)}}},api.replicate={},api.replicate.from=function(t,n,r){return typeof n=="function"&&(r=n,n={}),Pouch.replicate(t,api,n,r)},api.replicate.to=function(t,n,r){return typeof n=="function"&&(r=n,n={}),Pouch.replicate(api,t,n,r)},api.close=function(e){if(idb===null)return call(e,Pouch.Errors.NOT_OPEN);idb.close(),call(e,null)},api};IdbPouch.valid=function(){return document.location.host||console.error("indexedDB cannot be used in pages served from the filesystem"),!!window.indexedDB&&!!document.location.host},IdbPouch.destroy=function(t,n){Pouch.DEBUG&&console.log(t+": Delete Database"),IdbPouch.Changes.clearListeners(t);var r=indexedDB.deleteDatabase(t);r.onsuccess=function(){call(n,null)},r.onerror=idbError(n)},IdbPouch.Changes=Changes(),Pouch.adapter("idb",IdbPouch),"use strict";var POUCH_VERSION=1,POUCH_SIZE=5242880,DOC_STORE=quote("document-store"),BY_SEQ_STORE=quote("by-sequence"),ATTACH_STORE=quote("attach-store"),META_STORE=quote("metadata-store"),unknownError=function(e){return function(t){call(e,{status:500,error:t.type,reason:t.target})}},webSqlPouch=function(opts,callback){function dbCreated(){callback(null,api)}var api={},update_seq=0,name=opts.name,db=openDatabase(name,POUCH_VERSION,name,POUCH_SIZE);if(!db)return call(callback,Pouch.Errors.UNKNOWN_ERROR);db.transaction(function(e){var t="CREATE TABLE IF NOT EXISTS "+META_STORE+" (update_seq)",n="CREATE TABLE IF NOT EXISTS "+ATTACH_STORE+" (digest, json)",r="CREATE TABLE IF NOT EXISTS "+DOC_STORE+" (id unique, seq, json, winningseq)",i="CREATE TABLE IF NOT EXISTS "+BY_SEQ_STORE+" (seq INTEGER NOT NULL PRIMARY KEY AUTOINCREMENT, rev UNIQUE, json)";e.executeSql(n),e.executeSql(r),e.executeSql(i),e.executeSql(t);var s="SELECT update_seq FROM "+META_STORE;e.executeSql(s,[],function(e,t){if(!t.rows.length){var n="INSERT INTO "+META_STORE+" (update_seq) VALUES (?)";e.executeSql(n,[0]);return}update_seq=t.rows.item(0).update_seq})},unknownError(callback),dbCreated),api.type=function(){return"websql"},api.id=function(){var e=localJSON.get(name+"_id",null);return e===null&&(e=Math.uuid(),localJSON.set(name+"_id",e)),e},api.info=function(e){db.transaction(function(t){var n="SELECT COUNT(id) AS count FROM "+DOC_STORE;t.executeSql(n,[],function(t,n){e(null,{db_name:name,doc_count:n.rows.item(0).count,update_seq:update_seq})})})},api.bulkDocs=function(t,n,r){function c(e,t){return e._bulk_seq-t._bulk_seq}function h(e){var t=[];a.sort(c),a.forEach(function(e){delete e._bulk_seq;if(e.error){t.push(e);return}var n=e.metadata,r=Pouch.merge.winningRev(n);t.push({ok:!0,id:n.id,rev:r});if(/_local/.test(n.id))return;update_seq++;var i="UPDATE "+META_STORE+" SET update_seq=?";u.executeSql(i,[update_seq],function(){webSqlPouch.Changes.notify(name),localStorage[name]=localStorage[name]==="a"?"b":"a"})}),call(r,null,t)}function p(e,t,n){function c(e){r||(e?(r=e,call(t,r)):i==s.length&&p())}function h(r,i){var s=e.metadata.seq=i.insertId;delete e.metadata.rev;var o=Pouch.merge.winningRev(e.metadata),u=n?"UPDATE "+DOC_STORE+" SET seq=?, json=?, winningseq=(SELECT seq FROM "+BY_SEQ_STORE+" WHERE rev=?) WHERE id=?":"INSERT INTO "+DOC_STORE+" (id, seq, winningseq, json) VALUES (?, ?, ?, ?);",f=n?[s,JSON.stringify(e.metadata),o,e.metadata.id]:[e.metadata.id,s,s,JSON.stringify(e.metadata)];r.executeSql(u,f,function(n,r){a.push(e),call(t,null)})}function p(){var t=e.data,n="INSERT INTO "+BY_SEQ_STORE+" (rev, json) VALUES (?, ?);";u.executeSql(n,[t._rev,JSON.stringify(t)],h)}var r=null,i=0;e.data._id=e.metadata.id,e.data._rev=e.metadata.rev,isDeleted(e.metadata,e.metadata.rev)&&(e.data._deleted=!0);var s=e.data._attachments?Object.keys(e.data._attachments):[];for(var o in e.data._attachments)if(!e.data._attachments[o].stub){var f=e.data._attachments[o].data,l="md5-"+Crypto.MD5(f);delete e.data._attachments[o].data,e.data._attachments[o].digest=l,y(e,l,f,function(e){i++,c(e)})}else i++,c();s.length||p()}function d(e,t){var n=Pouch.merge(e.rev_tree,t.metadata.rev_tree[0],1e3),r=isDeleted(e)&&isDeleted(t.metadata)||!isDeleted(e)&&i&&n.conflicts!=="new_leaf";if(r)return a.push(g(Pouch.Errors.REV_CONFLICT,t._bulk_seq)),m();t.metadata.rev_tree=n.tree,p(t,m,!0)}function v(e){if("was_delete"in n&&isDeleted(e.metadata))return a.push(Pouch.Errors.MISSING_DOC),m();p(e,m,!1)}function m(){if(!f.length)return h();var e=f.shift(),t=e.metadata.id;t in l?d(l[t],e):v(e)}function g(e,t){return e._bulk_seq=t,e}function y(e,t,n,r){var i=[e.metadata.id,e.metadata.rev].join("@"),s={digest:t,body:n},o="SELECT * FROM "+ATTACH_STORE+" WHERE digest=?";u.executeSql(o,[t],function(e,n){n.rows.length?(s.refs=JSON.parse(n.rows.item(0).json).refs,o="UPDATE "+ATTACH_STORE+" SET json=? WHERE digest=?",e.executeSql(o,[JSON.stringify(s),t],function(){call(r,null)})):(s.refs={},s.refs[i]=!0,o="INSERT INTO "+ATTACH_STORE+"(digest, json) VALUES (?, ?)",e.executeSql(o,[t,JSON.stringify(s)],function(){call(r,null)}))})}function b(e,t){for(var n=0;n<t.rows.length;n++){var r=t.rows.item(n);l[r.id]=JSON.parse(r.json)}m()}typeof n=="function"&&(r=n,n={}),n||(n={});if(!t.docs)return call(r,Pouch.Errors.MISSING_BULK_DOCS);var i="new_edits"in n?n.new_edits:!0,s=extend(!0,[],t.docs),o=s.map(function(e,t){var n=parseDoc(e,i);return n._bulk_seq=t,e._deleted&&(n.metadata.deletions||(n.metadata.deletions={}),n.metadata.deletions[e._rev.split("-")[1]]=!0),n}),u,a=[],f=[],l={};o.forEach(function(e){if(e.error)return a.push(e);if(!f.length||e.metadata.id!==f[0].metadata.id)return f.unshift(e);a.push(g(Pouch.Errors.REV_CONFLICT,e._bulk_seq))}),db.transaction(function(e){u=e;var t="("+f.map(function(e){return quote(e.metadata.id)}).join(",")+")",n="SELECT * FROM "+DOC_STORE+" WHERE id IN "+t;u.executeSql(n,[],b)},unknownError(r))},api.put=function(e,t,n){return typeof t=="function"&&(n=t,t={}),!!e&&"_id"in e?api.bulkDocs({docs:[e]},t,yankError(n)):call(n,Pouch.Errors.MISSING_ID)},api.post=function(t,n,r){return typeof n=="function"&&(r=n,n={}),api.bulkDocs({docs:[t]},n,yankError(r))},api.revsDiff=function(t,n,r){function u(e,n,u){t[u].map(function(e){var t=function(t){return t.rev!==e};if(!n||n._revs_info.every(t))o[u]||(o[u]={missing:[]}),o[u].missing.push(e)});if(++s===i.length)return call(r,null,o)}typeof n=="function"&&(r=n,n={});var i=Object.keys(t),s=0,o={};i.map(function(e){api.get(e,{revs_info:!0},function(t,n){u(t,n,e)})})},api.remove=function(t,n,r){typeof n=="function"&&(r=n,n={}),n.was_delete=!0;var i=extend(!0,{},t);return i._deleted=!0,api.bulkDocs({docs:[i]},n,yankError(r))},api.get=function(e,t,n){typeof t=="function"&&(n=t,t={}),e=parseDocId(e);if(e.attachmentId!=="")return api.getAttachment(e,{decode:!0},n);var r;db.transaction(function(n){var i="SELECT * FROM "+DOC_STORE+" WHERE id=?";n.executeSql(i,[e.docId],function(e,n){if(!n.rows.length){r=Pouch.Errors.MISSING_DOC;return}var i=JSON.parse(n.rows.item(0).json);if(isDeleted(i,t.rev)&&!t.rev){r=Pouch.Errors.MISSING_DOC;return}var s=Pouch.merge.winningRev(i),o=t.rev?t.rev:s,u="SELECT * FROM "+BY_SEQ_STORE+" WHERE rev=?";e.executeSql(u,[o],function(e,n){var s=JSON.parse(n.rows.item(0).json);if(t.revs){var o=arrayFirst(rootToLeaf(i.rev_tree),function(e){return e.ids.indexOf(s._rev.split("-")[1])!==-1});o.ids.reverse(),s._revisions={start:o.pos+o.ids.length-1,ids:o.ids}}t.revs_info&&(s._revs_info=i.rev_tree.reduce(function(e,t){return e.concat(collectRevs(t))},[]));if(t.conflicts){var u=collectConflicts(i.rev_tree);u.length&&(s._conflicts=u)}if(t.attachments&&s._attachments){var a=Object.keys(s._attachments),f=0;a.forEach(function(t){api.getAttachment(s._id+"/"+t,{txn:e},function(e,n){s._attachments[t].data=n,++f===a.length&&(r=s)})})}else{if(s._attachments)for(var l in s._attachments)s._attachments[l].stub=!0;r=s}})})},unknownError(n),function(){"error"in r?call(n,r):call(n,null,r)})},api.allDocs=function(e,t){typeof e=="function"&&(t=e,e={});var n=[],r="startkey"in e?e.startkey:!1,i="endkey"in e?e.endkey:!1,s="descending"in e?e.descending:!1,o="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq";r&&(o+=" WHERE "+DOC_STORE+'.id >= "'+r+'"'),i&&(o+=(r?" AND ":" WHERE ")+DOC_STORE+'.id <= "'+i+'"'),o+=" ORDER BY "+DOC_STORE+".id "+(s?"DESC":"ASC"),db.transaction(function(t){t.executeSql(o,[],function(t,r){for(var i=0,s=r.rows.length;i<s;i++){var o=r.rows.item(i),u=JSON.parse(o.metadata),a=JSON.parse(o.data);if(!/_local/.test(u.id)&&!isDeleted(u)){var o={id:u.id,key:u.id,value:{rev:Pouch.merge.winningRev(u)}};e.include_docs&&(o.doc=a,o.doc._rev=Pouch.merge.winningRev(u),e.conflicts&&(o.doc._conflicts=collectConflicts(u.rev_tree))),n.push(o)}}})},unknownError(t),function(){call(t,null,{total_rows:n.length,rows:n})})},api.changes=function idb_changes(opts){function fetchChanges(){var e="SELECT "+DOC_STORE+".id, "+BY_SEQ_STORE+".seq, "+BY_SEQ_STORE+".json AS data, "+DOC_STORE+".json AS metadata FROM "+BY_SEQ_STORE+" JOIN "+DOC_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".winningseq WHERE "+DOC_STORE+".seq > "+opts.since+" ORDER BY "+DOC_STORE+".seq "+(descending?"DESC":"ASC");db.transaction(function(t){t.executeSql(e,[],function(e,t){for(var n=0,r=t.rows.length;n<r;n++){var i=t.rows.item(n),s=JSON.parse(i.metadata);if(!/_local/.test(s.id)){var o={id:s.id,seq:i.seq,changes:collectLeaves(s.rev_tree),doc:JSON.parse(i.data)};o.doc._rev=Pouch.merge.winningRev(s),isDeleted(s,o.doc._rev)&&(o.deleted=!0),opts.conflicts&&(o.doc._conflicts=collectConflicts(s.rev_tree)),results.push(o)}}for(var n=0,r=results.length;n<r;n++){var t=results[n];t&&dedupResults.push(t)}dedupResults.map(function(e){if(opts.filter&&!opts.filter.apply(this,[e.doc]))return;opts.include_docs||delete e.doc,e.seq>opts.since&&(opts.since=e.seq,call(opts.onChange,e))}),opts.continuous&&!opts.cancelled?webSqlPouch.Changes.addListener(name,id,api,opts):call(opts.complete,null,{results:dedupResults})})})}opts.since||(opts.since=0),Pouch.DEBUG&&console.log(name+": Start Changes Feed: continuous="+opts.continuous);var descending="descending"in opts?opts.descending:!1;descending=descending?"prev":null;var results=[],resultIndices={},dedupResults=[],id=name+":"+Math.uuid(),txn;if(opts.filter&&typeof opts.filter=="string"){var filterName=opts.filter.split("/");api.get("_design/"+filterName[0],function(err,ddoc){var filter=eval("(function() { return "+ddoc.filters[filterName[1]]+" })()");opts.filter=filter,fetchChanges()})}else fetchChanges();if(opts.continuous)return{cancel:function(){Pouch.DEBUG&&console.log(name+": Cancel Changes Feed"),opts.cancelled=!0,webSqlPouch.Changes.removeListener(name,id)}}},api.getAttachment=function(e,t,n){function i(e){return t.decode?atob(e):e}function s(s){var o="SELECT "+BY_SEQ_STORE+".json AS data FROM "+DOC_STORE+" JOIN "+BY_SEQ_STORE+" ON "+BY_SEQ_STORE+".seq = "+DOC_STORE+".seq WHERE "+DOC_STORE+'.id = "'+e.docId+'"';s.executeSql(o,[],function(s,o){var u=JSON.parse(o.rows.item(0).data),a=u._attachments[e.attachmentId],f=a.digest,l=a.content_type,c="SELECT * FROM "+ATTACH_STORE+" WHERE digest=?";s.executeSql(c,[f],function(e,s){var o=JSON.parse(s.rows.item(0).json).body;r=i(o),"txn"in t&&call(n,null,r)})})}t instanceof Function&&(n=t,t={}),typeof e=="string"&&(e=parseDocId(e));var r;"txn"in t?s(t.txn):db.transaction(s,unknownError(n),function(){call(n,null,r)})},api.putAttachment=function(t,n,r,i,s){t=parseDocId(t),api.get(t.docId,{attachments:!0},function(e,n){n._attachments||(n._attachments={}),n._attachments[t.attachmentId]={content_type:i,data:btoa(r)},api.put(n,s)})},api.removeAttachment=function(t,n,r){t=parseDocId(t),api.get(t.docId,function(e,i){if(e){call(r,e);return}if(i._rev!=n){call(r,Pouch.Errors.REV_CONFLICT);return}i._attachments||(i._attachments={}),delete i._attachments[t.attachmentId],api.put(i,r)})},api.replicate={},api.replicate.from=function(t,n,r){return typeof n=="function"&&(r=n,n={}),Pouch.replicate(t,api,n,r)},api.replicate.to=function(t,n,r){return typeof n=="function"&&(r=n,n={}),Pouch.replicate(api,t,n,r)}};webSqlPouch.valid=function(){return!!window.openDatabase},webSqlPouch.destroy=function(e,t){var n=openDatabase(e,POUCH_VERSION,e,POUCH_SIZE);localJSON.set(e+"_id",null),n.transaction(function(e){e.executeSql("DROP TABLE IF EXISTS "+DOC_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+BY_SEQ_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+ATTACH_STORE,[]),e.executeSql("DROP TABLE IF EXISTS "+META_STORE,[])},unknownError(t),function(){call(t,null)})},webSqlPouch.Changes=Changes(),Pouch.adapter("websql",webSqlPouch),"use strict";var MapReduce=function(db){function viewQuery(fun,options){function sum(e){return e.reduce(function(e,t){return e+t},0)}if(!options.complete)return;var results=[],current=null,num_started=0,completed=!1,emit=function(e,t){var n={id:current.doc._id,key:e,value:t};if(options.startkey&&Pouch.collate(e,options.startkey)<0)return;if(options.endkey&&Pouch.collate(e,options.endkey)>0)return;if(options.key&&Pouch.collate(e,options.key)!==0)return;num_started++;if(options.include_docs){if(t&&typeof t=="object"&&t._id){db.get(t._id,function(e,t){t&&(n.doc=t),results.push(n),checkComplete()});return}n.doc=current.doc}results.push(n)};eval("fun.map = "+fun.map.toString()+";"),fun.reduce&&eval("fun.reduce = "+fun.reduce.toString()+";");var conflicts="conflicts"in options?options.conflicts:!1,checkComplete=function(){if(completed&&results.length==num_started){results.sort(function(e,t){return Pouch.collate(e.key,t.key)}),options.descending&&results.reverse();if(options.reduce===!1)return options.complete(null,{rows:results});var e=[];results.forEach(function(t){var n=e[e.length-1]||null;if(n&&Pouch.collate(n.key[0][0],t.key)===0){n.key.push([t.key,t.id]),n.value.push(t.value);return}e.push({key:[[t.key,t.id]],value:[t.value]})}),e.forEach(function(e){e.value=fun.reduce(e.key,e.value)||null,e.key=e.key[0][0]}),options.complete(null,{rows:e})}};db.changes({conflicts:conflicts,include_docs:!0,onChange:function(e){"deleted"in e||(current={doc:e.doc},fun.map.call(this,e.doc))},complete:function(){completed=!0,checkComplete()}})}function httpQuery(e,t,n){var r=[],i=undefined,s="GET";typeof t.reduce!="undefined"&&r.push("reduce="+t.reduce),typeof t.include_docs!="undefined"&&r.push("include_docs="+t.include_docs),typeof t.limit!="undefined"&&r.push("limit="+t.limit),typeof t.descending!="undefined"&&r.push("descending="+t.descending),typeof t.startkey!="undefined"&&r.push("startkey="+encodeURIComponent(JSON.stringify(t.startkey))),typeof t.endkey!="undefined"&&r.push("endkey="+encodeURIComponent(JSON.stringify(t.endkey))),typeof t.key!="undefined"&&r.push("key="+encodeURIComponent(JSON.stringify(t.key))),typeof t.keys!="undefined"&&(s="POST",i=JSON.stringify({keys:t.keys})),r=r.join("&"),r=r===""?"":"?"+r;if(typeof e=="string"){var o=e.split("/");db.request({method:s,url:"_design/"+o[0]+"/_view/"+o[1]+r,body:i},n);return}var u=JSON.parse(JSON.stringify(e,function(e,t){return typeof t=="function"?t+"":t}));db.request({method:"POST",url:"_temp_view"+r,body:u},n)}function query(e,t,n){typeof t=="function"&&(n=t,t={}),n&&(t.complete=n);if(db.type()==="http")return httpQuery(e,t,n);if(typeof e=="object")return viewQuery(e,t);var r=e.split("/");db.get("_design/"+r[0],function(e,i){if(e){n&&n(e);return}viewQuery({map:i.views[r[1]].map,reduce:i.views[r[1]].reduce},t)})}return{query:query}};MapReduce._delete=function(){},Pouch.plugin("mapreduce",MapReduce)}(this),function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define([],t):e.garden_views=t()}(this,function(){var e={};return e.by_active_install={map:function(e){if(!e.type||e.type!=="install")return;if(e.removed)return;emit(e.dashboard_title,null)}},e.dashboard_assets={map:function(e){var t;e._id=="settings"&&emit([0],e);if(!e.type)return;if(e.type==="install"){if(e.removed)return;t=Number.MAX_VALUE,e.order&&(t=Number(e.order)),emit([1,t,e.dashboard_title,"install"],{db:e.installed.db})}if(e.type==="link"){if(e.removed)return;t=Number.MAX_VALUE,e.order&&(t=Number(e.order)),emit([1,t,e.dashboard_title,"link"],{url:e.url})}e.type==="theme"&&e.selectedTheme&&emit([2],null),e.type==="script"&&emit([3],e._rev)}},e.cache_manifest={map:function(e){var t;e._id=="settings"&&emit([0],e);if(!e.type)return;if(e.type==="install"){if(e.removed)return;t=Number.MAX_VALUE,e.order&&(t=Number(e.order)),emit([1,t],e._rev)}if(e.type==="link"){if(e.removed)return;t=Number.MAX_VALUE,e.order&&(t=Number(e.order)),emit([1,t],e._rev)}e.type==="theme"&&e.selectedTheme&&emit([2],e._rev),e.type==="script"&&emit([3],e._rev)}},e.app_version_by_market={map:function(e){if(!e.type||e.type!=="install")return;if(e.removed)return;var t="details/"+e.doc_id,n=e.src.substring(0,e.src.indexOf(t)),r=e.couchapp||e.kanso;emit(n,{dashboard_title:e.dashboard_title,app:e.doc_id,version:r.config.version})}},e.get_markets={map:function(e){e.type&&e.type==="market"&&emit(e.name,e.url)}},e.get_roles={map:function(e){e.type&&e.type==="role"&&emit(e.name,e.url)}},e.get_syncs={map:function(e){e.type&&e.type==="sync"&&emit(e.name,null)}},e}),function(e,t){typeof exports=="object"?module.exports=t(require("async"),require("pouchdb"),require("garden-views"),require("url")):typeof define=="function"&&define.amd?define(["async","pouchdb","garden-views","url"],t):e.garden_dashboard_core=t(e.async,e.Pouch,e.garden_views,e.url)}(this,function(e,t,n,r){var i={};return i.dashboard=function(e,t){var n=this;n.dashboard_db_url=e,n.pouchName=i.getPouchName(e)},i.dashboard.prototype.init=function(n){var r=this;e.parallel({local:function(e){t(r.pouchName,e)},remote:function(e){t(r.dashboard_db_url,e)}},function(e,t){if(e)return n(e);r.local_db=t.local,r.remote_db=t.remote,n()})},i.dashboard.prototype.sync=function(e){t.replicate(this.remote_db,this.local_db,{},e)},i.dashboard.prototype.allAssets=function(e){this.local_db.allDocs(e)},i.dashboard.prototype.settings=function(e){this.local_db.get("settings",function(t,n){if(t&&t.status===404)return e(null,{});e(t,n)})},i.dashboard.prototype.topbar=function(t){var r={settingsDoc:{},selectedThemeDoc:null,apps:[],scripts:[]};this.local_db.query(n.dashboard_assets,{reduce:!1,include_docs:!0},function(n,i){e.forEach(i.rows,function(e,t){e.key[0]===0&&(r.settingsDoc=e.value),e.key[0]===1&&(e.key[3]=="install"&&r.apps.push({title:e.key[2],db:e.value.db,doc:e.doc}),e.key[3]=="link"&&r.apps.push({title:e.key[2],link:e.value.url,doc:e.doc,external:!0})),e.key[0]===2&&(r.selectedThemeDoc=e.doc),e.key[0]===3&&r.scripts.push(e.doc.src),t()},function(e){t(e,r)})})},i.getPouchName=function(e){var t=r.parse(e),n=t.hostname+t.port;if(t.pathname){var i=t.pathname.replace(/\//g,"_");n+=i}return n},i.dashboard}),function(e,t){typeof exports=="object"?module.exports=t():typeof define=="function"&&define.amd?define([],t):e.garden_default_settings=t()}(this,function(){return{frontpage:{use_markdown:!0,use_html:!1,show_activity_feed:!1,markdown:"## Welcome to your Garden\n\nHere are some things you might want to do:\n\n- [Configure](./settings#/frontpage) this front page.\n- [Install](./install) some apps.\n- [Sync](./settings#/sync) with another garden.\n\n\n\n"},host_options:{short_urls:!1,hostnames:"http://localhost:5984,http://0.0.0.0:5985",short_app_urls:!0,rootDashboard:!1,hosted:!1,login_type:"local"},top_nav_bar:{bg_color:"#1D1D1D",link_color:"#BFBFBF",active_link_color:"#FFFFFF",active_link_bg_color:"#000000",active_bar_color:"#bd0000",show_brand:!1,icon_name:null,brand_link:null,show_gravatar:!0,show_username:!0,notification_theme:"libnotify",admin_show_futon:!1},sessions:{type:"internal",internal:{login_type:"local",redirect_frontpage_on_anon:!1},other:{login_url:"/users/_design/users-default/_rewrite/#/login",login_url_next:"/users/_design/users-default/_rewrite/#/login/{next}",signup_url:"/users/_design/users-default/_rewrite/#/signup",profile_url:"/users/_design/users-default/_rewrite/#/profile/{username}"}}}}),function(e,t){typeof exports=="object"?module.exports=t(require("underscore"),require("garden-dashboard-core"),require("garden-default-settings"),require("url")):typeof define=="function"&&define.amd?define(["underscore","garden-dashboard-core","garden-default-settings","url"],t):e.garden_menu=t(e._,e.garden_dashboard_core,e.garden_default_settings,e.url)}(this,function(e,t,n,r){var i=function(e){this.dashboard_db_url=e,this.dashboard_core=new t(e)};return i.prototype.init=function(t){var r=this;r.dashboard_core.init(function(i){if(i)return t(i);r.dashboard_core.sync(function(i){i,r.dashboard_core.settings(function(i,s){if(i)return t(i);r.settings=e.defaults(s,n),t(null,r.settings)})})})},i.prototype.getAppLinks=function(t,n){var r=this,i=r.settings,s=r.dashboard_ui_url(),o=s,u=s+"settings";i.frontpage.use_link&&(o=i.frontpage.link_url),n||(n=t,t={}),r.dashboard_core.topbar(function(i,s){s.apps=e.map(s.apps,function(e){return e.db&&(e.link=r.app_url_ui(e.doc)),e.doc.remote_user&&t.username&&e.doc.remote_user!==username&&(e.remote_user_warning=!0,e.remote_user=e.doc.remote_user),e}),s.grouped_apps=e.groupBy(s.apps,function(e){return e.doc.onDropdownMenu?"more_apps":"apps"}),n(null,s)})},i.prototype.dashboard_ui_url=function(){if(this.settings.host_options.rootDashboard){var t=!1;if(typeof window!="undefined"){var n=window.location.host,i=this.settings.host_options.hostnames.split(",");e.each(i,function(i){var s=r.parse(i),o=s.hostname;s.port!="80"&&(e.isString(s.port)||e.isNumber(s.port))&&(o+=":"+s.port),o==n&&(t=!0)});if(t)return"/"}}return"/dashboard/_design/dashboard/_rewrite/"},i.prototype.app_url_ui=function(t){var n=t.couchapp||t.kanso;try{if(n.config.legacy_mode)return"/"+t.installed.db+"/_design/"+t.doc_id+t.open_path}catch(i){}if(typeof window!="undefined"&&this.settings.host_options.short_urls&&this.settings.host_options.short_app_urls){var s=!1,o=window.location.host,u=this.settings.host_options.hostnames.split(",");e.each(u,function(t){var n=r.parse(t),i=n.hostname;n.port!="80"&&(e.isString(n.port)||e.isNumber(n.port))&&(i+=":"+n.port),i==o&&(s=!0)});if(s)return"/"+t.installed.db+"/"}return"/"+t.installed.db+"/_design/"+t.doc_id+t.open_path},i.prototype.app_settings_ui=function(e){return this.settings.host_options.rootDashboard?"/settings#/apps/"+e._id:"/dashboard/_design/dashboard/_rewrite/settings#/apps/"+e._id},i}),function(e,t){typeof exports=="object"?module.exports=t(require("url"),require("garden-menu")):typeof define=="function"&&define.amd?define(["url","garden-menu"],t):e.garden_menu_widget=t(e.url,e.garden_menu)}(this,function(e,t){var n=function(e){this.dashboard_db_url=e,this.menu_core=new t(e)};return n.prototype.init=function(e){var t=this;t.menu_core.init(function(n,r){t.menu_core.getAppLinks(function(t,n){console.log(t,n),e(null)})})},n});var root=window.location,db=url.resolve(root,"/dashboard");ui=new garden_menu_widget(db),ui.init(function(e){console.log("init",e)})})();